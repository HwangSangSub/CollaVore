<div class="page-wrapper" xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">

<style>
.breadcrumb {
	background-color: #ffffff;
	padding: 5px 20px;
	border-radius: 10px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	height: 70px;
	display: flex;
	justify-content: space-between; /* 좌우로 분리 */
	align-items: center;
	width: calc(100% - 40px);
	max-width: 1000px;
	margin: 20px;
	color: #333;
	position: relative;
	display: flex; /* 상대적 위치 설정 */
}

.breadcrumb-left {
	display: flex;
	align-items: center;
}

.breadcrumb-right {
	position: absolute;
	right: 20px; /* 오른쪽 여백 */
	top: 20px; /* 상단 여백 */
}

.breadcrumb h4 {
	margin: 0;
	font-size: 24px;
	font-weight: bold;
	color: #333;
	margin-right: 10px; /* 제목과 내비게이션 간의 여백 */
}

.breadcrumb-left nav {
	margin-top: 9px; /* 글자를 아래로 10px 이동 */
	font-size: 16px;
}

.breadcrumb nav a {
	color: #333;
	text-decoration: none;
	margin: 0 10px;
	font-weight: normal;
}

.breadcrumb nav a:first-child {
	margin-left: 0;
}

.breadcrumb nav a:hover {
	text-decoration: underline;
}

.breadcrumb-right span {
	font-size: 14px;
	color: #999;
	white-space: nowrap; /* 경로 표시 부분이 줄바꿈되지 않게 함 */
	position: relative; /* 상대적인 위치 설정 */
	top: -12px; /* 글자를 위로 5px 이동 */
}

.card_posi, .card_jobs, .card_org {
	background-color: #ffffff;
	padding: 0 20px; /* 상단과 하단 패딩을 0, 왼쪽과 오른쪽은 20px 유지 */
	border-radius: 10px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	width: calc(100% - 40px); /* 양옆 20px씩 마진을 주기 위해 너비 계산 */
	max-width: 1000px; /* 최대 너비를 설정하여 너무 넓지 않게 유지 */
	margin: 20px; /* 상단 20px, 양옆 20px, 하단 0px 마진 */
}

.inline-container {
	display: flex;
	justify-content: space-between; /* 제목은 왼쪽, 버튼은 오른쪽 정렬 */
	align-items: center; /* 텍스트와 버튼을 수직 가운데 정렬 */
	padding: 10px 0; /* 상하 여백 추가 */
}

.inline-jobs-container {
	display: flex; /* 직무를 가로로 나열 */
	gap: 10px; /* 각 직무 간 간격 */
	flex-wrap: wrap; /* 줄 바꿈이 가능하도록 설정 */
	overflow-x: visible; /* 필요 시 가로 스크롤을 없애거나 줄 바꿈 */
}

.inline-jobs-container div {
	padding: 5px 10px;
	background-color: #e6e6fa;
	border-radius: 4px;
	white-space: nowrap; /* 직무명이 길어져도 줄 바꿈 없이 한 줄 유지 */
	cursor: pointer; /* 마우스를 올리면 클릭 가능한 느낌 */
	position: relative; /* 삭제 버튼을 위한 상대 위치 */
	margin: 10px; /*바깥 여백*/
	display: flex;
	align-items: center;
}

.inline-jobs-container div span, .inline-jobs-container div input {
	display: block;
	width: auto; /* 글자 수에 따라 너비 자동 조정 */
	max-width: 100%; /* 너무 길어지지 않도록 최대 너비 제한 */
	padding: 5px 10px; /* 동일한 패딩 적용 */
	background-color: #e6e6fa; /* 배경색 통일 */
	border-radius: 4px;
	box-sizing: border-box; /* 패딩이 너비에 포함되도록 설정 */
	font-size: 14px; /* 폰트 크기 */
	font-weight: bold; /* 폰트 굵기 */
	text-align: center; /* 글자 중앙 정렬 */
	line-height: 1.5; /* 텍스트 수직 중앙 정렬을 위한 줄 높이 */
	white-space: nowrap; /* 글자 줄바꿈 방지 */
}

.inline-jobs-container div input {
	border: 1px solid #ddd; /* 인풋 필드 테두리 */
}

.inline-jobs-container div input:focus {
	outline: none;
	border-color: #007bff; /* 포커스 시 테두리 색상 변경 */
	box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); /* 포커스 시 그림자 */
}

.inline-jobs-container div:hover {
	background-color: #d8bfd8; /* 호버 시 배경색 변경 */
}

/* 삭제 버튼을 숨겨두고 호버 시에만 나타나도록 설정 */
.inline-jobs-container div button {
	display: none; /* 기본 상태에서 숨김 */
	position: absolute;
	right: -8px;
	top: -19%;
	transform: translateY(-50%);
	background-color: red;
	color: white;
	border: none;
	border-radius: 50%;
	width: 20px;
	height: 20px;
	cursor: pointer;
}

.inline-jobs-container div:hover button {
	display: block; /* 마우스를 직무에 올리면 삭제 버튼 보이게 설정 */
	/* Flexbox로 가운데 정렬 */
	display: flex;
	justify-content: center; /* 수평 중앙 정렬 */
	align-items: center; /* 수직 중앙 정렬 */
	font-size: 14px; /* 텍스트 크기 조절 */
	line-height: 1; /* 텍스트 줄 높이 */
}

.tooltip-text {
	visibility: hidden;
	background-color: #555;
	color: #fff;
	text-align: center;
	border-radius: 5px;
	padding: 5px 10px;
	position: absolute;
	z-index: 1;
	bottom: 57%; /* 아이콘 아래에 뜨도록 */
	left: 27%;
	transform: translateX(-50%); /* 가운데 정렬 */
	opacity: 0;
	transition: opacity 0.3s;
}
/* 아이콘에 마우스를 올렸을 때 툴팁 표시 */
.tooltip-icon:hover+.tooltip-text {
	visibility: visible;
	opacity: 1;
}

h4 {
	margin: 0;
}

table {
	width: 100%;
	border-collapse: collapse;
}

th, td {
	padding: 8px;
	text-align: left;
	border-bottom: 1px solid #ddd; /* 가로선만 추가 */
}

th {
	border-top: 1px solid #ddd; /* 테이블의 첫 번째 행(헤더)에 상단 가로선 추가 */
}

th:first-child, td:first-child {
	background-color: #e6e6fa; /* 연보라색(Lavender) */
	font-weight: bold;
}

input {
	padding: 8px;
	font-size: 14px;
	border: 1px solid #ddd;
	border-radius: 4px; /* 모서리를 둥글게 */
	width: 100%;
	box-sizing: border-box; /* padding이 포함된 전체 너비를 맞추기 위해 사용 */
}

input:focus {
	outline: none;
	border-color: #007bff; /* 포커스 시 테두리 색상 변경 */
	box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); /* 포커스 시 외곽선에 그림자 추가 */
}

button {
	margin-top: 10px;
	margin-bottom: 10px;
	padding: 5px 10px;
	background-color: #d8bfd8;
	border-radius: 4px;
	color: white;
	border: none;
	cursor: pointer;
	float: right;
	justify-content: flex-end;
}

button:hover {
	background-color: #0056b3;
}

/* 버튼 오른쪽 정렬을 위한 컨테이너 */
.button-container {
	margin-top: 10px;
	display: flex;
	justify-content: flex-end; /* 버튼을 오른쪽 정렬 */
	align-items: center; /* 버튼 높이 일치 */
	gap: 10px; /* 버튼 간격 */
	margin-bottom: 20px;
}
</style>
<div class="purple-background-container">
	<div class="breadcrumb">
		<div class="breadcrumb-left">
			<h4>조직관리</h4>
			<nav>
				<a href="#position-section">직위관리</a> | <a href="#job-section">직무관리</a>
				| <a href="#org-section">조직관리</a>
			</nav>
		</div>
		<div class="breadcrumb-right">
			<span>관리자 페이지 > 조직관리</span>
		</div>
	</div>

	<!-- ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── -->

	<div class="card_posi" id="position-section">
		<div class="inline-container">
			<h4>
				직위 관리 <i class="fas fa-question-circle tooltip-icon"></i>
				<div class="tooltip-text">직위 관리에 대한 안내</div>
			</h4>
			<button onclick="addLevel()">
				<i class="fas fa-plus"></i>
			</button>
		</div>

		<table id="positionTable">
			<tr>
				<th>Level</th>
				<th>직위</th>
				<th></th>
			</tr>
		</table>
		<div class="button-container">
			<button onclick="saveData()">저장</button>
		</div>
	</div>

	<!-- ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── -->

	<div class="card_jobs" id="job-section">
		<div class="inline-container">
			<h4>
				직무 관리 <i class="fas fa-question-circle tooltip-icon"></i>
				<div class="tooltip-text">직무 관리에 대한 안내</div>
			</h4>
			<button onclick="addJob()">
				<i class="fas fa-plus"></i>
			</button>
		</div>

		<div class="inline-jobs-container" id="jobsTable">
			<!-- 직무들이 여기에 동적으로 추가됩니다 -->
		</div>

		<div class="button-container">
			<button onclick="saveJobs()">저장</button>
		</div>
	</div>

	<!-- ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── -->

	<div class="card_org" id="org-section">
		<!-- 조직 관리 내용 -->
	</div>

</div>
</div>
<script>
//──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
// 직위 데이터 로드
let levelCounter = 1;

// 페이지 로드 시 기존 데이터 불러오기
function loadExistingData() {
	fetch('/positions/getExistingPositions')
    .then(response => response.json())
    .then(data => {
        const table = document.getElementById('positionTable');

        // 첫 번째와 두 번째 tr을 제외한 나머지 tr 제거
        while (table.rows.length > 1) {
            table.deleteRow(1); // 항상 3번째 행(인덱스 2)을 삭제
        }

        // 데이터로 테이블 업데이트
        data.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>Level. ${index + 1}</td>
                <td><input type="text" value="${item.posiName}" data-posi-no="${item.posiNo}" /></td>
                <td><button onclick="removeLevel(this, ${item.posiNo})"><i class="fas fa-minus"></i></button></td>
            `;
            table.appendChild(row);
            levelCounter = index + 1; // 레벨 카운터 업데이트
        });
    });
}

// 새 레벨 추가 함수
function addLevel() {
    levelCounter++;
    const table = document.getElementById('positionTable');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>Level. ${levelCounter}</td>
        <td><input type="text" placeholder="새 직위 입력" /></td>
        <td><button onclick="removeLevel(this)"><i class="fas fa-minus"></i></button></td>
    `;
    table.appendChild(row);
    reorderLevels();
}

//레벨 삭제 함수
function removeLevel(button, posiNo = null) {
    // 확인 대화 상자
    if (confirm('정말로 삭제하시겠습니까?')) {
        if (posiNo) {
            // 서버로 삭제 요청
            fetch(`/positions/delete/${posiNo}`, {
                method: 'DELETE'
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'success') {
                    button.parentElement.parentElement.remove();
                    reorderLevels();
                } else {
                    alert('삭제에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error deleting position:', error);
                alert('삭제 중 오류가 발생했습니다.');
            });
        } else {
            // 새로 추가된 레벨의 경우 화면에서만 삭제
            button.parentElement.parentElement.remove();
            reorderLevels();
        }
    }
}

// 레벨 재정렬
function reorderLevels() {
    const rows = document.querySelectorAll('#positionTable tr');
    rows.forEach((row, index) => {
        if (index === 0) return; // 헤더는 제외
        row.cells[0].textContent = `Level. ${index}`;
    });
}

// 데이터 저장 함수
function saveData() {
    const rows = document.querySelectorAll('#positionTable tr');
    const positions = [];
	let nonName = false;
    rows.forEach((row, index) => {
        if (index === 0) return; // 첫 번째는 헤더이므로 제외
        const posiNo = row.cells[1].querySelector('input').dataset.posiNo || null;
        const posiName = row.cells[1].querySelector('input').value.trim();
		if(posiName == ''){
			nonName = true;
		}
        positions.push({
            posiNo: posiNo,
            posiName: posiName,
            grade: index // 레벨을 등급으로 사용
        });
    });
    
    if(nonName){
    	alert("직위명이 입력되지 않았습니다. 확인 후 다시 시도해주세요.");
    	return;
    }

    console.log(positions);  // 전송할 데이터를 콘솔에 출력
    // 서버에 데이터 전송 (AJAX 사용)
    fetch('/positions/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(positions)
    })
    .then(response => response.text())
    .then(result => {
        //console.log(result);  // 서버로부터 받은 응답을 콘솔에 출력
        if (result === 'success') {
            alert('저장되었습니다.');
            loadExistingData();
        } else {
            alert('저장에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('에러 발생!');
    });
}
// 페이지 로드 시 기존 데이터 불러오기
document.addEventListener('DOMContentLoaded', loadExistingData);


// ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
// 직무 데이터 로드
function loadExistingJobs() {
    fetch('/jobs/getExistingJobs')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('jobsTable');
        container.innerHTML = ''; // 기존 데이터 초기화

        // 데이터를 이용해 직무 테이블 업데이트
        data.forEach(item => {
            const div = document.createElement('div');
            div.innerHTML = `
                <span onclick="editJob(this)">${item.jobName}</span>
                <button data-job-no="${item.jobNo}" onclick="removeJob(this, ${item.jobNo})">X</button>
            `;
            container.appendChild(div);
        });
    })
    .catch(error => {
        console.error('Error fetching jobs:', error);
    });
}

// 새 직무 추가 함수
function addJob() {
    const container = document.getElementById('jobsTable');
    const div = document.createElement('div');
    div.innerHTML = `
        <input type="text" placeholder="새 직무 입력" />
        <button onclick="removeJob(this)">X</button>
    `; 
    container.appendChild(div);
}

// 직무 수정 함수 (span을 클릭했을 때 실행)
function editJob(span) {
    const jobName = span.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = jobName;
    input.onblur = function() {
        // 수정된 값을 입력 후 focus가 사라질 때 span으로 다시 변환
        if (input.value.trim() !== '') {
            span.textContent = input.value.trim();
        } else {
            span.textContent = jobName; // 값이 없을 경우 기존 값으로 되돌림
        }
        span.style.display = 'inline';
        input.remove(); // input 제거
    };
    span.style.display = 'none';
    span.parentNode.insertBefore(input, span);
    input.focus(); // 바로 입력할 수 있도록 포커스 설정
}

//직무 삭제 함수
function removeJob(button, jobNo = null) {
    // 확인 대화 상자
    if (confirm('정말로 삭제하시겠습니까?')) {
        if (jobNo) {
            // 서버로 삭제 요청
            fetch(`/jobs/delete/${jobNo}`, {
                method: 'DELETE'
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'success') {
                    button.parentElement.remove();
                } else {
                    alert('삭제에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error deleting job:', error);
                alert('삭제 중 오류가 발생했습니다.');
            });
        } else {
            // 새로 추가된 직무는 화면에서만 삭제
            button.parentElement.remove();
        }
    }
}


// 직무 데이터 저장 함수
function saveJobs() {
    const divs = document.querySelectorAll('#jobsTable div');
    const jobs = [];
    let nonName = false;

    divs.forEach(div => {
        const span = div.querySelector('span');
        const jobNameInput = div.querySelector('input');
        const jobName = jobNameInput ? jobNameInput.value.trim() : span.textContent.trim();
        const button = div.querySelector('button');
        const jobNo = jobNameInput ? null : (button ? button.dataset.jobNo : null); 

        if (jobName === '') {
            nonName = true;
        }

        jobs.push({
            jobNo: jobNo,
            jobName: jobName,
        });
    });
    
    if (nonName) {
        alert("직무명이 입력되지 않았습니다. 확인 후 다시 시도해주세요.");
        return;
    }

    // 서버에 직무 데이터 전송
    fetch('/jobs/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jobs)
    })
    .then(response => response.text())
    .then(result => {
        if (result === 'success') {
            alert('저장되었습니다.');
            loadExistingJobs();
        } else {
            alert('저장에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error saving jobs:', error);
        alert('에러 발생!');
    });
}

// 페이지 로드 시 직무 데이터 불러오기
document.addEventListener('DOMContentLoaded', loadExistingJobs);


</script>