<div class="page-wrapper" xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">

<style>
.card_posi,.card_jobs {
	background-color: #ffffff;
	padding: 20px;
	border-radius: 10px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	width: calc(100% - 40px); /* 양옆 20px씩 마진을 주기 위해 너비 계산 */
	max-width: 1000px; /* 최대 너비를 설정하여 너무 넓지 않게 유지 */
	margin: 20px 20px 0 20px; /* 상단 20px, 양옆 20px, 하단 0px 마진 */
}

.inline-container {
    display: flex;
    justify-content: space-between; /* 제목은 왼쪽, 버튼은 오른쪽 정렬 */
    align-items: center; /* 텍스트와 버튼을 수직 가운데 정렬 */
    padding: 10px 0; /* 상하 여백 추가 */
}



.tooltip-text {
    visibility: hidden;
    background-color: #555;
    color: #fff;
    text-align: center;
    border-radius: 5px;
    padding: 5px 10px;
    position: absolute;
    z-index: 1;
    bottom: 57%; /* 아이콘 아래에 뜨도록 */
    left: 27%;
    transform: translateX(-50%); /* 가운데 정렬 */
    opacity: 0;
    transition: opacity 0.3s;

}
/* 아이콘에 마우스를 올렸을 때 툴팁 표시 */
.tooltip-icon:hover + .tooltip-text {
    visibility: visible;
    opacity: 1;
}

h4{
margin: 0
}
table {
	width: 100%;
	border-collapse: collapse;
}

th, td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd; /* 가로선만 추가 */
}

th {
    border-top: 1px solid #ddd; /* 테이블의 첫 번째 행(헤더)에 상단 가로선 추가 */
}
th:first-child,td:first-child {
    background-color: #e6e6fa; /* 연보라색(Lavender) */
    font-weight: bold;
}

input {
    padding: 8px;
    font-size: 14px;
    border: 1px solid #ddd;
    border-radius: 4px; /* 모서리를 둥글게 */
    width: 100%;
    box-sizing: border-box; /* padding이 포함된 전체 너비를 맞추기 위해 사용 */
}

input:focus {
    outline: none;
    border-color: #007bff; /* 포커스 시 테두리 색상 변경 */
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); /* 포커스 시 외곽선에 그림자 추가 */
}

button {
	padding: 5px 10px;
	justify-content: flex-end;
	background-color: #d8bfd8;
	border-radius: 4px;
	color: white;
	border: none;
	cursor: pointer;
	float: right;
}

button:hover {
	background-color: #0056b3;
}

/* 버튼 오른쪽 정렬을 위한 컨테이너 */
.button-container {
margin-top: 10px;
    display: flex;
    justify-content: flex-end; /* 버튼을 오른쪽 정렬 */
    align-items: center; /* 버튼 높이 일치 */
    gap: 10px; /* 버튼 간격 */
    margin-bottom: 20px;
}


/* td 안의 - 버튼 동그랗게 */
td button {
    width: 30px;
    height: 30px;
    padding: 0;
    border-radius: 50%; /* 버튼을 동그랗게 만듦 */
    justify-content: flex-end;
    font-size: 16px;
    background-color: #e6e6fa;
}

td button:hover {
    background-color: #c8a2c8;
}


</style>
	
	<div class="card_jobs">
		<div class="inline-container">
		<h4>직무 관리 <i class="fas fa-question-circle tooltip-icon"></i>
		<div class="tooltip-text">직뮤 관리에 대한 안내</div></h4>
		<button onclick="addLevel()"><i class="fas fa-plus"></i></button>
		</div>
		
		<table id="jobsTable">
			<tbody>
				<tr>
					<td>
						<span></span>
					</td>
				</tr>
			</tbody>
		</table>
		<div class="button-container">
		<button onclick="saveData()">저장</button>
		</div>
	</div>

</div>

  <script>
    let jobCounter = 1; // 직무 레벨 카운터

    // 직무 데이터 로드
    function loadExistingJobs() {
        fetch('/jobs/getExistingJobs') // 직무 데이터를 가져오는 API
        .then(response => response.json())
        .then(data => {
            const table = document.getElementById('jobsTable').querySelector('tbody');



            // 데이터를 이용해 직무 테이블 업데이트
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span>${item.jobName}</span></td>
                    <td><button onclick="removeJob(this, ${item.jobNo})"><i class="fas fa-minus"></i></button></td>
                `;
                table.appendChild(row);
                jobCounter = index + 1;
            });
        });
    }

    // 새 직무 추가 함수
    function addJob() {
        jobCounter++;
        const table = document.getElementById('jobsTable').querySelector('tbody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" placeholder="새 직무 입력" /></td>
            <td><button onclick="removeJob(this)"><i class="fas fa-minus"></i></button></td>
        `;
        table.appendChild(row);
    }

    // 직무 삭제 함수
    function removeJob(button, jobNo = null) {
        if (jobNo) {
            // 서버로 삭제 요청
            fetch(`/jobs/delete/${jobNo}`, {
                method: 'DELETE'
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'success') {
                    button.parentElement.parentElement.remove();
                } else {
                    alert('삭제에 실패했습니다.');
                }
            });
        } else {
            // 새로 추가된 직무는 그냥 삭제
            button.parentElement.parentElement.remove();
        }
    }

    // 직무 데이터 저장 함수
    function saveJobs() {
        const rows = document.querySelectorAll('#jobsTable tr');
        const jobs = [];
        let nonName = false;
        
        rows.forEach((row, index) => {
            const jobNameInput = row.querySelector('input');
            const jobName = jobNameInput ? jobNameInput.value.trim() : row.querySelector('span').textContent;
            const jobNo = jobNameInput ? null : row.querySelector('button').dataset.jobNo;

            if (jobName === '') {
                nonName = true;
            }

            jobs.push({
                jobNo: jobNo,
                jobName: jobName,
            });
        });
        
        if (nonName) {
            alert("직무명이 입력되지 않았습니다. 확인 후 다시 시도해주세요.");
            return;
        }

        // 서버에 직무 데이터 전송
        fetch('/jobs/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(jobs)
        })
        .then(response => response.text())
        .then(result => {
            if (result === 'success') {
                alert('저장되었습니다.');
                loadExistingJobs(); // 저장 후 새로 로드
            } else {
                alert('저장에 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('에러 발생!');
        });
    }

    // 페이지 로드 시 직무 데이터 불러오기
    document.addEventListener('DOMContentLoaded', loadExistingJobs);
</script>
  