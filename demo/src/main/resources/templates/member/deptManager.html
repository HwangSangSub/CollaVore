<div class="page-wrapper" xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">

<style>

/* card_org 스타일 */
.card_org {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    width: calc(100% - 40px); 
    max-width: 1000px;
    margin: 20px auto; 
    box-sizing: border-box;
    overflow-x: auto; /* 가로 스크롤 추가 */
}

/* inline-Dept-container (부서 트리 컨테이너를 가로로 정렬) */
.inline-Dept-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 20px 0;
}

/* 각 부서 항목 */
.dept-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    margin-bottom: 20px;
}

/* 각 부서 정보 (이름 + 사원 수) */
.dept-info {
    cursor: pointer;
    font-weight: bold;
    padding: 8px 12px;
    border-radius: 5px;
    background-color: #e6ecf7;
    display: inline-block;
    font-size: 0.9em;
    color: #333;
    margin-bottom: 10px;
}

/* 자식 부서 컨테이너 */
.child-container {
    display: flex;
    flex-direction: row; /* 자식 부서를 가로로 배치 */
    justify-content: space-around;
    align-items: flex-start;
    position: relative;
    width: 100%;
}

/* 상위 부서와 연결되는 세로선 */
.dept-item::before {
    content: '';
    position: absolute;
    top: -20px;
    left: 50%;
    width: 1px;
    height: 20px;
    background-color: #ccc;
}
.dept-info {
    cursor: pointer;
    font-weight: bold;
    padding: 8px 12px;
    border-radius: 5px;
    background-color: #e6ecf7;
    display: flex; /* Flexbox 추가 */
    justify-content: space-between; /* 좌우 정렬 */
    align-items: center; /* 세로 정렬 */
    font-size: 0.9em;
    color: #333;
    margin-bottom: 10px;
    width: 150px;
}

.dept-name {
    /* 부서명에 추가적인 스타일을 줄 수 있습니다. */
}

.emp-count {
    /* 사원 수에 추가적인 스타일을 줄 수 있습니다. */
}

/* 하위 부서와 연결되는 가로선 */
.child-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background-color: #ccc;
}

/* 최상위 부서에서는 세로선을 없앰 */
.level-1 .dept-item::before {
    display: none;
}

/* 각 레벨 스타일링 */
.level-1 {
    font-size: 1.2em;
    font-weight: bold;
    color: #333;
    margin-bottom: 20px;
}

.level-2 {
    font-size: 1.1em;
    color: #333;
}

.level-3 {
    font-size: 1.0em;
    color: #555;
}

.level-4 {
    font-size: 0.9em;
    color: #777;
}

</style>


	

		<div class="card_org" id="org-section">
			<div class="inline-container">
				<h4>
					조직 관리 <i class="fas fa-question-circle tooltip-icon"></i>
					<div class="tooltip-text">조직 관리에 대한 안내</div>
				</h4>
				<button onclick="addDept()">
					<i class="fas fa-plus"></i>
				</button>
			</div>

			<div class="inline-Dept-container" id="DeptTable">
				<!-- 조직도 뿌려지는 곳 -->
			</div>

			<div class="button-container">
				<button onclick="saveDept()">저장</button>
			</div>
		</div>
	</div>

	<script>
//──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────// 서버에서 부서 데이터를 가져오는 함수
async function fetchDeptData() {
    try {
        const response = await fetch('/dept/getExistingDepts');  // 실제 API 엔드포인트로 수정
        const departments = await response.json();  // JSON 형태로 변환

        if (departments && departments.length > 0) {
            // 받아온 데이터를 트리 형태로 렌더링
            renderDeptTree(departments);
        } else {
            console.error('서버로부터 받은 부서 데이터가 비어있습니다.');
        }
    } catch (error) {
        console.error('부서 데이터를 가져오는 중 오류 발생:', error);
    }
}

// 부서 데이터를 트리 구조로 렌더링
function renderDeptTree(departments) {
    const deptTable = document.getElementById('DeptTable');
    deptTable.innerHTML = ''; // 기존 내용을 초기화

    const deptMap = {};
    const levelMap = {};

    // 부서 데이터를 맵으로 변환 (부서 번호를 키로 사용)
    departments.forEach(dept => {
        deptMap[dept.deptNo] = { ...dept, children: [] }; // 각 부서에 children 배열을 미리 초기화
    });

    // 상위 부서에 자식 부서 연결
    departments.forEach(dept => {
        if (dept.parentDeptNo !== null && dept.parentDeptNo !== 0 && deptMap[dept.parentDeptNo]) {
            deptMap[dept.parentDeptNo].children.push(deptMap[dept.deptNo]);
        }
    });

    // 부서별 레벨 계산
    function calculateLevel(deptNo, currentLevel = 1) {
        const dept = deptMap[deptNo];
        if (!levelMap[currentLevel]) levelMap[currentLevel] = [];
        levelMap[currentLevel].push(dept);
        
        dept.children.forEach(child => {
            calculateLevel(child.deptNo, currentLevel + 1);
        });
    }

    // 최상위 부서를 가져와 트리로 렌더링 (parentDeptNo가 null 또는 0인 부서)
    const rootDepartments = departments.filter(dept => dept.parentDeptNo === null || dept.parentDeptNo === 0);
    
    // 최상위 부서부터 각 레벨별로 부서를 렌더링
    rootDepartments.forEach(rootDept => {
        calculateLevel(rootDept.deptNo);  // 레벨별로 부서를 계산
    });

    // 레벨별로 부서를 렌더링
    Object.keys(levelMap).forEach(level => {
        const levelContainer = document.createElement('div');
        levelContainer.classList.add('level-container');
        levelContainer.innerHTML = `<h4>Level.${level}</h4>`;

        levelMap[level].forEach(dept => {
            const deptHTML = generateDeptHTML(dept);
            levelContainer.appendChild(deptHTML);
        });

        deptTable.appendChild(levelContainer);
    });
}

// 부서 트리 HTML을 재귀적으로 생성
function generateDeptHTML(dept) {
    const deptElement = document.createElement('div');
    deptElement.classList.add('dept-item');

    const deptName = dept.deptName !== null ? dept.deptName : 'N/A';
    const empCnt = dept.empCnt !== null ? dept.empCnt : '0';

    deptElement.innerHTML = `
        <div class="dept-info">
            <span class="dept-name">${deptName}</span>
            <span> <i class="fas fa-ellipsis-h"></i> </span>
            <span class="emp-count"><i class="fas fa-user"></i> ${empCnt}</span>
        </div>
    `;

    return deptElement;
}

// 페이지가 로드될 때 데이터를 가져와서 트리 구조로 렌더링
document.addEventListener('DOMContentLoaded', () => {
    fetchDeptData();  // 서버에서 데이터를 받아와 렌더링
});

</script>