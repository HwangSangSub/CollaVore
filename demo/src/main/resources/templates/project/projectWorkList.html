<div class="page-wrapper" xmlns:th="https://www.thymeleaf.org/"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{common/layouts/default_layout}"
     layout:fragment="Content">
    <head>
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    </head>
    <style>
        .no-border-button {
            border: none;
            background: transparent; 
            padding: 0; 
            cursor: pointer; 
        }
		.insert-panel {
		    border: 1px solid #ccc;
		    padding: 10px;
		    margin-left: 20px;
		    overflow: hidden; /* 내용이 넘치지 않도록 설정 */
		    transition: max-height 0.3s ease; /* 부드러운 전환 효과 */
		}
        
    </style>
    <div class="container-fluid" th:data-current-table="${table}" id="fluidDiv">
        <div class="row">
            <div id="jstree" class="col-md-6">
                <!-- <ul>
                    <li id="node_collavore">Collavore -->
                        <ul>
                    <th:block th:each="project : ${projects}" th:if="${project.parentNo == null}">
                        <th:block th:replace="~{::renderNode(projno=${project.no}, projname=${project.name}, parentNo=${project.parentNo}, table=${project.table}, level=${project.level}, jobNo=${project.jobNo}, pdwNo=${project.pdwNo})}"></th:block>
                    </th:block>                            <!-- 자식 노드가 여기에 추가될 수 있습니다. -->
                        </ul>
                    <!-- </li>
                </ul> -->
            </div>
            <div class="col-md-6">
                <div class="insert-panel" id="insertPanelProjwrks"style="display: none;">
                    <h4>Insert Project</h4>
                    <form id="insertFormProjwrks">
                        <div>
                            <label for="nameProjWrks" class="form-label">업무 이름</label>
                            <input type="text" id="nameProjWrks" name="name" class="form-control" required>
                        </div>   
                        <div>
                            <label class="form-label">업무 내용</label>
                            <input type="text" id="contentProjWrks" name="content" class="form-control" required>
                        </div>   
                        <div>
                            <label class="form-label">업무 타입</label>
                            <select class="form-select" name="jobNo" id="jobNoProjWrks" required>
							<option value="0">선택하세요</option>
							<option th:each="info : ${jobs}"
								th:value="${info.jobNo}">[[${info.name}]]</option>
						</select>
                        </div>   
                        <div>
                           <label class="form-label" id="wrklabel" style="display: none;">업무 담당자</label>
							<select class="form-select" name="mgrNo" id="mgrNoProjWrks" style="display: none;" required>
								<option value="0">선택하세요</option>
								<option th:each="info : ${projmgriist}"
									th:value="${info.empNo}">[[${info.name}]]</option>
							</select>
                        </div>
                        <input type="hidden" id="projNo" name="projNo">
                        <div>
                            <button type="submit" class="btn btn-primary">생성</button>
                        </div>
                    </form>
                </div>
                <div class="insert-panel" id="insertPanelProjdwrks"style="display: none;">
                    <h4>Insert Project</h4>
                    <form id="insertFormProjdwrks">
                        <div>
                            <label for="nameProjDwrks" class="form-label">업무 이름</label>
                            <input type="text" id="nameProjDwrks" name="name" class="form-control" required>
                        </div>                 
                        <div>
                            <label class="form-label">업무 내용</label>
                            <input type="text" id="contentProjDwrks" name="content" class="form-control" required>
                        </div>                  
                        <label for="importance" class="form-label">중요도</label>
                        <select class="form-select" name="importance" id="importance" required>
                            <option value="" disabled selected>선택하세요</option>
                            <option value="l1">낮음</option>
                            <option value="l2">중간</option>
                            <option value="l3">높음</option>
                        </select>    
                        <label for="isStatus" class="form-label">진행상황</label>
			            <select class="form-select" name="isStatus" id="insertisStatus" required>
			                <option value="" disabled selected>선택하세요</option>
			                <option value="k1">진행전</option>
			                <option value="k2">진행중</option>
			                <option value="k3">완 료</option>
			            </select>           
                        <div>
                            <label class="form-label">업무 시작일</label>
                            <input type="date" id="startDate" name="startDate" class="form-control" required>
                        </div>                 
                        <div>
                            <label class="form-label">업무 종료일</label>
                            <input type="date" id="compDate" name="compDate" class="form-control" required>
                        </div>                 
                        <div>
                            <label class="form-label">프로젝트 깃 커밋ID</label>
                            <input type="text" id="commitId" name="commitId" class="form-control" required>
                        </div>                 
                        <div>
                            <label class="form-label" id="wrklabel2">업무 담당자</label>
							<select class="form-select" name="mgrNo" id="mgrNoProjdWrks" required>
								<option value="0">선택하세요</option>
								<option th:each="info : ${projmgriist}"
									th:value="${info.empNo}">[[${info.name}]]</option>
							</select>
                            
                        </div>
                        <div>
                            <input type="hidden" id="selPwNo" name="selPwNo">
                        </div>	                 
                        <div>
                            <input type="hidden" id="selParentPdwNo" name="selParentPdwNo">
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary">생성</button>
                        </div>
                    </form>
                </div>



    <div class="insert-panel" id="wrkInfo" style="display: none;">
    <h4>업무 수정</h4>
    <form id="updateFormWrks">
        <div>
            <label for="nameProjWrks" class="form-label">업무 이름</label>
            <input type="text" id="nameProjWrksUpdate" name="name" class="form-control" required>
        </div>
        <div>
            <label class="form-label">업무 내용</label>
            <input type="text" id="contentProjWrksUpdate" name="content" class="form-control" required>
        </div>
            <div>
                <label class="form-label">업무 타입</label>
                <select class="form-select" name="jobNo" id="jobNoWrks" required>
					<option value="0">선택하세요</option>
					<option th:each="info : ${jobs}"
						th:value="${info.jobNo}">[[${info.name}]]</option>
				</select>
             </div>   
            <div>
               <label class="form-label" >업무 담당자</label>
				<select class="form-select" name="mgrNo" id="mgrNoProjWrksUpdate2"required>
					<option value="0">선택하세요</option>
					<option th:each="info : ${projmgriist}"
						th:value="${info.empNo}">[[${info.name}]]</option>
				</select>
           </div>
        <div>
        </div>
        	<input type="hidden" id="pwNo" name="pwNo" class="form-control">
        <div>
            <button type="submit" class="btn btn-primary">수정</button>
        </div>
    </form>
</div>
    <div class="insert-panel" id="dwrkInfo" style="display: none;">
        <h4>Insert Project</h4>
        <form id="updateFormProjdwrks">
            <div>
                <label for="nameProjDwrks" class="form-label">상세업무 이름</label>
                <input type="text" id="projdwrkname" name="name" class="form-control" required>
            </div>
            <div>
                <label class="form-label">상세업무 내용</label>
                <input type="text" id="projdwrkcontent" name="content" class="form-control" required>
            </div>
            <label for="importance" class="form-label">중요도</label>
            <select class="form-select" name="importance" id="updateimportance" required>
                <option value="" disabled selected>선택하세요</option>
                <option value="l1">낮음</option>
                <option value="l2">중간</option>
                <option value="l3">높음</option>
            </select>
            <label for="isStatus" class="form-label">진행상황</label>
            <select class="form-select" name="isStatus" id="updateisStatus" required>
                <option value="" disabled selected>선택하세요</option>
                <option value="k1">진행전</option>
                <option value="k2">진행중</option>
                <option value="k3">완 료</option>
            </select>            
            <div>
                <label class="form-label">업무 시작일</label>
                <input type="date" id="updatestartDate" name="startDate" class="form-control" required>
            </div>
            <div>
                <label class="form-label">업무 종료일</label>
                <input type="date" id="updatecompDate" name="compDate" class="form-control" required>
            </div>
            <div>
                <label class="form-label">프로젝트 깃 커밋ID</label>
                <input type="text" id="updatecommitId" name="commitId" class="form-control" required>
            </div>
            <div>
            </div>
               <div>
                 <label class="form-label" id="wrklabel2">업무 담당자</label>
					<select class="form-select" name="mgrNo" id="updatemgrNoProjDwrks" required>
						<option value="0">선택하세요</option>
						<option th:each="info : ${projmgriist}"
							th:value="${info.empNo}">[[${info.name}]]</option>
					</select>
                </div>            
            	<input type="hidden" id="pdwNo" name="pdwNo" class="form-control">
            <div>
                <button type="submit" class="btn btn-primary">수정</button>
            </div>
        </form>
    </div>
    <div class="insert-panel" id="editProjectModal" style="display: none;">
        <h4>프로젝트 수정</h4>
        <form id="editProjectForm">
            <div>
                <label for="nameProjDwrks" class="form-label">프로젝트 이름</label>
                <input type="text" id="editProjName" name="name" class="form-control" required>
            </div>
            <div>
                <label class="form-label">프로젝트 내용</label>
                <input type="text" id="editProjContent" name="content" class="form-control" required>
            </div>
            <div>
               
                  <label class="form-label">업무 타입</label>
                  <select class="form-select" name="jobNo" id="editjobNoProjWrks" required>
					<option value="0">선택하세요</option>
					<option th:each="info : ${jobs}"
						th:value="${info.jobNo}">[[${info.name}]]</option>
				</select>
               </div>   
               <div>
                 <label class="form-label" id="wrklabel">업무 담당자</label>
					<select class="form-select" name="pMgrNo" id="editProjManager" required>
						<option value="0">선택하세요</option>
						<option th:each="info : ${projmgriist}"
							th:value="${info.empNo}">[[${info.name}]] </option>
					</select>
					
                </div>                
            <div>
                <label class="form-label">프로젝트 git 주소</label>
                <input type="text" id="editProjGit" name="projectGitUrl" class="form-control" required>
            </div>
            <div class="mb-3">
				<label for="editProjStatus" class="form-label">진행상태</label> 
					<select class="form-select" name="isStatus" id="editProjStatus" required>
						<option value="">선택하세요</option>
						<option value="j1">진행전</option>
						<option value="j2">진행중</option>
						<option value="j3">완료</option>
					</select>
				</div>
            <div>
                <label class="form-label">시작일</label>
                <input type="date" id="editProjStartDate" name="startDate" class="form-control" required>
            </div>
            <div>
                <label class="form-label">마감일</label>
                <input type="date" id="editProjEndDate" name="endDate" class="form-control" required>
            </div>
				<input type="hidden" id="projNo" name="projNo" class="form-control">
            <div>
                <button type="submit" class="btn btn-primary">수정</button>
            </div>
        </form>
    </div>
 			<div class="card" id = "chat" style="display: none;">
                <div class="card-body">
                  <h4 class="card-title">Chat Option</h4>
                  <div class="chat-box scrollable" style="height: 475px">
                  <span class="badge rounded-pill bg-secondary"  th:if="${isStatus == 'k1'}">진행전</span> 
                  <span class="badge rounded-pill bg-info" th:if="${isStatus == 'k2'}">진행중</span> 
                  <span class="badge rounded-pill bg-success" th:if="${isStatus == 'k3'}">완 료</span>
                  
                    <!--chat Row -->
                    <ul class="chat-list" id="chat-list">
                      <!--chat Row -->
                      
                      <li class="chat-item" >
                        <div class="chat-img">
                          <img src="/assets/images/users/default.png" alt="user" />
                        </div>
                        <div class="chat-content">
                          <h6 class="font-medium"></h6>
                          <div class="box bg-light-info">
                            
                          </div>
                        </div>
                        <div class="chat-time"></div>
                      </li>
                     
                      <li class="odd chat-item" >
                        <div class="chat-content">
                          <div class="box bg-light-inverse">
                           
                          </div>
                          <br />
                        </div>
                        <div class="chat-time"></div>
                      </li>
					
                    </ul>
                  </div>
                </div>
                <div class="card-body border-top">
                  <div class="row">
                    <div class="col-9">
                      <div class="input-field mt-0 mb-0">
                        <textarea id="textarea1" placeholder="이곳에 입력하세요" class="form-control border-0"></textarea>
                      </div>
                    </div>
                    <div class="col-3">
                     <input type="hidden" name="pdwNo" id="pdwNode"> 
                     <a class="btn-circle btn-lg btn-cyan float-end text-white" id="send-chat-btn">
					    <i class="mdi mdi-send fs-3">
                      </i>
                     </a>
                    </div>
</div></div></div>
            </div>
        </div>
    </div>


    <!-- Include jQuery library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
    <!-- Include jsTree -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

    <script>
    // 세션 아이디 변수
    const sessionUserEmpNo = '[[${session.userEmpNo}]]';
    
    // sysdate날짜 
    function getCurrentDate() {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
        const day = String(date.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
    }
    
        $(document).ready(function() {
            $('#jstree').jstree(); 

            $('#jstree').on('click', '.no-border-button', function(e) {
                e.stopPropagation(); 
                $(this).siblings('ul').toggle(); 
            });

            $('#insertFormProjwrks').on('submit', function(e) {
                e.preventDefault(); // 기본 제출 이벤트 방지
                const formData = $(this).serialize(); // 폼 데이터 직렬화
                
                $.ajax({
                    type: 'POST',
                    url: '/project/projectwrkinsert', // 폼의 action URL
                    data: formData,
                    success: function(response) {
                        alert('프로젝트가 성공적으로 추가되었습니다: ' + response.data.name);
                        
                        // jsTree에 새 노드 추가
                        const newNode = {
                            id: 'node_' + response.data.projNo, // 새 노드의 ID
                            text: response.data.name, // 새 노드의 텍스트
                            children: [] // 자식 노드 초기화
                        };
                        $('#jstree').jstree().create_node('#', newNode, 'last'); // jsTree에 노드 추가
                        
                        // 폼 초기화
                        $('#insertFormProjwrks')[0].reset();
                    },
                    error: function(xhr, status, error) {
                        alert('오류가 발생했습니다: ' + error);
                    }
                });
            });

            $('#insertFormProjdwrks').on('submit', function(e) {
                e.preventDefault(); // 기본 제출 이벤트 방지
                const formData = $(this).serialize(); // 폼 데이터 직렬화
                
                $.ajax({
                    type: 'POST',
                    url: '/project/projectdwrkinsert', // 폼의 action URL
                    data: formData,
                    success: function(response) {
                        alert('상세 업무가 성공적으로 추가되었습니다: ');
                        console.log(response);
                        // jsTree에 새 상세 업무 노드 추가
                        const parentNodeId = 'node_' + response.data.parentNo; // 부모 노드 ID
                        const newDetailNode = {
                            id: 'node_' + response.data.pdNo, // 새 상세 업무 노드의 ID
                            text: response.data.name, // 새 상세 업무 노드의 텍스트
                            children: [] // 자식 노드 초기화
                        };

                        $('#jstree').jstree().create_node(parentNodeId, newDetailNode, 'last'); // jsTree에 노드 추가

                        // 폼 초기화
                        $('#insertFormProjdwrks')[0].reset();
                    },
                    error: function(xhr, status, error) {
                        alert('오류가 발생했습니다: ' + error);
                    }
                });
            });
        });

        function myFunction(buttonElement, level, jobNo) {
            const projectName = $(buttonElement).parent().find('span').text().trim();

            const projNo = $(buttonElement).parent().attr('id').split('_')[1];

            let currentNode = $(buttonElement).parent();
            let pwNo = null;

            // 최상위 부모 찾기
            while (currentNode.length) {
                const currentPwNo = currentNode.attr('id').split('_')[1];
                
                // pwNo 값이 존재하면 저장
                if (currentPwNo) {
                    pwNo = currentPwNo; // 최상위 부모의 pwNo로 업데이트
                }

                // 부모 노드로 이동
                currentNode = currentNode.parent().closest('li'); // 부모 <li>를 찾기
            }
           
            
            
            if (level <= 1) {
                $('#insertPanelProjwrks h4').text(projectName + ' 업무 등록');
                $('#insertPanelProjwrks').show();
                $('#insertPanelProjdwrks').hide();
                $('#dwrkInfo').hide();
                $('#wrkInfo').hide();
                $('#editProjectModal').hide();
                $('#chat').hide();
                
            } else {
                $('#insertPanelProjdwrks h4').text(projectName + ' 상세업무 등록');
                handleJobNoChange(jobNo);
                $('#test').show();
                $('#insertPanelProjwrks').hide();
                $('#insertPanelProjdwrks').show();
                $('#dwrkInfo').hide();
                $('#wrkInfo').hide();
                $('#editProjectModal').hide();
                $('#chat').hide();
            }

            $('#projNo').val(projNo.replace(/^[PW]/, ''));
            /* $('#parentPdwNo').val(projNo.replace(/^[PW]/, ''));
            $('#pwNo').val(pwNo.replace(/^[PW]/, '')); */
            //$('#projNo').val(projNo);
            $('#selParentPdwNo').val(projNo);
            $('#selPwNo').val(pwNo);

        }
        
        
    
        function myInfo(buttonElement, level) {
            const projectName = $(buttonElement).text(); 
            const projNo = $(buttonElement).parent().attr('id').split('_')[1]; 
            const pwNo = parseInt(projNo.replace(/^[PW]/, ''), 10); 
            
            
            if (level <= 1) {
            	$.ajax({
                    url: `/project/projectlistinfo/${pwNo}`, 
                    type: 'GET',
                    success: function(response) {
                    	// 옵션값 함수 호출
                    	handleJobNoChange(response.jobNo);
                       
                      	
                    	$('#editProjectModal').show();
                        $('#wrkInfo').hide();
                        $('#dwrkInfo').hide();
                        $('#insertPanelProjdwrks').hide();
                        $('#insertPanelProjwrks').hide();
                        $('#chat').hide();
                        
                        
                        $('#editProjName').val(response.name);
                        $('#editProjContent').val(response.content);
                        setTimeout(() => {
                            $('#editProjManager').val(response.pmgrNo); // 선택된 값을 설정
                        }, 50);
                        $('#editProjGit').val(response.projectGitUrl);
                        $('#editProjStatus').val(response.status);
                        $('#projNo').val(response.projNo);
                        $('#editjobNoProjWrks').val(response.jobNo);
                        
                        const formatDate = (dateString) => {
                            const date = new Date(dateString);
                            return date.toISOString().split('T')[0]; 
                        }; 
                        $('#editProjStartDate').val(formatDate(response.startDate));
                        $('#editProjEndDate').val(formatDate(response.endDate));   
                    }
            	});
            }else if(level <= 2){
                $('#wrkInfo h4').text(projectName + ' 업무 수정');
                $('#wrkInfo').show();
                $('#editProjectModal').hide();
                $('#dwrkInfo').hide();
                $('#insertPanelProjdwrks').hide();
                $('#insertPanelProjwrks').hide();
                $('#chat').hide();
                
                $.ajax({
                    url: `/project/projectwrklistinfo/${pwNo}`, 
                    type: 'GET',
                    dataType: 'json', 
                    success: function(response) {
                    	// 옵션값 함수 호출
                    	handleJobNoChange(response.jobNo);
                    	
                        $('#nameProjWrksUpdate').val(response.name);
                        $('#contentProjWrksUpdate').val(response.content);
                        $('#jobNoWrks').val(response.jobNo);
                        setTimeout(() => {
                            $('#mgrNoProjWrksUpdate2').val(response.mgrNo); // 선택된 값을 설정
                        }, 50);
                    },
                    error: function(xhr, status, error) {
                        alert('프로젝트 정보를 가져오는 데 실패했습니다: ' + error);
                    }
                });
            }else {
                $('#dwrkInfo h4').text(projectName + ' 상세업무 수정');
                $('#wrkInfo').hide();
                $('#dwrkInfo').show();  
                $('#insertPanelProjdwrks').hide();
                $('#insertPanelProjwrks').hide();
                $('#editProjectModal').hide();
                $('#chat').hide();
                
                $.ajax({
                    url: `/project/projectdwrkinfo/${pwNo}`, 
                    type: 'GET',
                    dataType: 'json', 
                    success: function(response) {
                    	console.log(response);
                    	handleJobNoChange(response.jobNo);
                        $('#projdwrkname').val(response.name);
                        $('#projdwrkcontent').val(response.content);
                        $('#updateimportance').val(response.importance); 
                        const formatDate = (dateString) => {
                            const date = new Date(dateString);
                            return date.toISOString().split('T')[0]; 
                        }; 
                        $('#updatestartDate').val(formatDate(response.startDate));
                        $('#updatecompDate').val(formatDate(response.compDate));
                        $('#updatecommitId').val(response.commitId);
                        $('#hiddenjobNoWrks').val(response.jobNo);
                        setTimeout(() => {
                            $('#updatemgrNoProjDwrks').val(response.mgrNo); // 선택된 값을 설정
                        }, 50);
                        $('#updateisStatus').val(response.isStatus);
                        $('#selPwNo').val(pwNo); 
                        $('#selParentPdwNo').val(projNo); 
                    },
                    error: function(xhr, status, error) {
                        alert('프로젝트 정보를 가져오는 데 실패했습니다: ' + error);
                    }
                });
            }
            
            // projNo를 hidden input에 설정
            $('#projNo').val(projNo.replace(/^[PW]/, '')); 
            $('#pwNo').val(pwNo); 
            $('#pdwNo').val(pwNo); 
            
            $('#selPwNo').val(pwNo); 
            $('#selParentPdwNo').val(projNo); 
            
            
        }
    	// 프로젝트 수정 처리
        $('#editProjectForm').on('submit', function(e) {
        	console.log($('#editProjManager').val());
        	e.preventDefault();
            $.ajax({
                url: `/project/projectupdate`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    projNo: $('#projNo').val(),
                    name: $('#editProjName').val(),
                    content: $('#editProjContent').val(),
                    pmgrNo: $('#editProjManager').val(),
                    projectGitUrl: $('#editProjGit').val(),
                    status: $('#editProjStatus').val(),
                    startDate: $('#editProjStartDate').val(),
                    endDate: $('#editProjEndDate').val()
                    

                }),
                success: function(response) {
                    alert('프로젝트가 성공적으로 수정되었습니다!');

                    $('#editProjectModal').hide(); // 수정 모달 닫기
                },
                error: function(xhr, status, error) {
                    alert('프로젝트 수정에 실패했습니다: ' + error);
                }
            });
        });
    	
    	
     // 업무 수정 처리
        $('#updateFormWrks').on('submit', function(e) {
        	e.preventDefault();
            $.ajax({
                url: `/project/projectwrkupdate`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    pwNo: $('#pwNo').val(),
                    name: $('#nameProjWrksUpdate').val(),
                    content: $('#contentProjWrksUpdate').val(),
                    jobNo: $('#jobNoWrks').val(),
                    mgrNo: $('#mgrNoProjWrksUpdate').val(),
                    

                }),
                success: function(response) {
                    alert('프로젝트가 성공적으로 수정되었습니다!');

                    $('#updateFormProjdwrks').hide();
                },
                error: function(xhr, status, error) {
                    alert('프로젝트 수정에 실패했습니다: ' + error);
                }
            });
        });
     // 상세업무 수정 처리
        $('#updateFormProjdwrks').on('submit', function(e) {
        	e.preventDefault();
            
            $.ajax({
                url: `/project/projectdwrkupdate`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    pdwNo: $('#pdwNo').val(),
                    name: $('#projdwrkname').val(),
                    content: $('#projdwrkcontent').val(),
                    isStatus: $('#updateisStatus').val(),
                    startDate: $('#updatestartDate').val(),
                    compDate: $('#updateendDate').val(),
                    commitId: $('#updatecommitId').val(),
                    importance: $('#updateimportance').val(),
                    mgrNo: $('#updatemgrNoProjDwrks').val(),
                    

                }),
                success: function(response) {
                    alert('상세업무가 성공적으로 수정되었습니다!');

                    $('#dwrkInfo').hide(); // 수정 모달 닫기
                },
                error: function(xhr, status, error) {
                    alert('프로젝트 수정에 실패했습니다: ' + error);
                }
            });
        });   
        function toggleChat(buttonElement, level) {
            const projectName = $(buttonElement).text();
            const projNo = $(buttonElement).parent().attr('id').split('_')[1];
            const pdwNo = parseInt(projNo.replace(/^[PW]/, ''), 10);

            const chat = document.getElementById('chat');
            if (level >= 3) {
                $('#chat').show();
                $('#editProjectModal').hide();
                $('#wrkInfo').hide();
                $('#dwrkInfo').hide();
                $('#insertPanelProjdwrks').hide();
                $('#insertPanelProjwrks').hide();

                $('#chat h4').text(projectName + ' 상세업무 코멘트');
                $('#pdwNode').val(pdwNo);
                $.ajax({
                    url: '/project/projecdwrkcomtstinfo/' + pdwNo,
                    method: 'GET',
                    success: function(data) {
                        const chatList = $('#chat .chat-list');
                        chatList.empty();
                        
                     	// 기존 배지 제거
                        $('#chat .badge').remove();
                     	// 기존 버튼 제거
                        $('#chat .status-button').remove();
                     	
                        if (Array.isArray(data)) {
                            // 상태를 먼저 확인하여 배지 생성
                            let statusBadge = '';
                            // 버튼 생성
                            let actionButton = '';
                            
                            // status값에 따라 뱃지 및 버튼 구별
                            if (data.length > 0) {
                                const firstInfo = data[0];
                                if (firstInfo.isStatus === 'k1') {
                                    statusBadge = '<span class="badge rounded-pill bg-secondary">진행전</span>';
                                    actionButton = `
                                        <button type="button" class="btn btn-outline-info status-button" onclick="updateStatus('k1')" style="float: right;">
                                            작업시작
                                        </button>`;
                                } else if (firstInfo.isStatus === 'k2') {
                                    statusBadge = '<span class="badge rounded-pill bg-info">진행중</span>';
                                    actionButton = `
                                        <button type="button" class="btn btn-outline-success status-button"onclick="updateStatus( 'k2')" style="float: right;">
                                            컨펌요청
                                        </button>`;
                                } else if (firstInfo.isStatus === 'k3') {
                                	statusBadge = '<span class="badge rounded-pill bg-info">컨펌중</span>';
                                }else if (firstInfo.isStatus === 'k4'){
                                	statusBadge = '<span class="badge rounded-pill bg-success">완료</span>';
                                }
                                
                            }
							// status값에 따라 뱃지 및 버튼 노출
                            $('#chat h4').after(statusBadge);
                            $('#chat h4').append(actionButton);
                            
                            data.forEach(info => {
                                const isCurrentUser = parseInt(sessionUserEmpNo, 10) === parseInt(info.writerNo, 10);

                                function formatDate(dateString) {
                                    const date = new Date(dateString);
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    return `${year}-${month}-${day}`;
                                }

                                const chatItem = isCurrentUser
                                    ? `
                                        <li class="odd chat-item">
                                            <div class="chat-content">
                                                <div class="box bg-light-inverse">${info.content}</div>
                                                <br />
                                            </div>
                                            <div class="chat-time">${formatDate(info.regDate)}</div>
                                        </li>`
                                    : `
                                        <li class="chat-item">
                                            <div class="chat-img">
                                                <img src="/assets/images/users/default.png" alt="user" />
                                            </div>
                                            <div class="chat-content">
                                                <h6 class="font-medium">${info.name}</h6>
                                                <div class="box bg-light-info">${info.content}</div>
                                            </div>
                                            <div class="chat-time">${formatDate(info.regDate)}</div>
                                        </li>`;

                                chatList.append(chatItem); // 생성한 HTML 요소를 chat-list에 추가
                            });

                        }
                    },
                    error: function(error) {
                        console.error("오류발생!:", error);
                    }
                });
            }
        }

     	
        // 상세업무 코멘트 등록
       $(document).ready(function() {
    // 채팅 메시지 전송 함수
    function sendMessage() {
        const message = $('#textarea1').val().trim(); // textarea의 내용을 가져옴
        //const pdwNo = $('#chat').data('pdwNo');
        const pdwNo = $('#pdwNode').val();
		//console.log(pdwNo);
        const writerNo = sessionUserEmpNo;
		
        if (message) {
            $.ajax({
                type: 'POST',
                url: '/project/projectdwrkcomtinsert', // 메시지를 처리할 서버 URL
                data: JSON.stringify({ content: message, pdwNo: pdwNo, writerNo: writerNo }),
                contentType: 'application/json',
                success: function(response) {
                    // 응답 처리 (예: 서버에서 반환된 채팅 내용을 추가)
                    const chatItem = `
                        <li class="odd chat-item">
                            <div class="chat-content">
                                <div class="box bg-light-inverse">${response.content}</div>
                                <br />
                            </div>
                            <div class="chat-time">${getCurrentDate()}</div>
                        </li>`;
                    
                    $('#chat-list').append(chatItem); // chat-list에 새 메시지 추가
                    $('#textarea1').val(''); // textarea 초기화
                },
                error: function(xhr, status, error) {
                    alert('코멘트 전송에 실패했습니다: ' + error);
                }
            });
        } else {
            alert('코멘트를 입력하세요!');
        }
    }

    // 버튼 클릭 이벤트
    $('#send-chat-btn').on('click', function() {
    	 
        sendMessage();
    });

    // 엔터 키 입력 이벤트
    $('#textarea1').on('keypress', function(event) {
        if (event.which === 13) { // 엔터 키
            event.preventDefault(); // 기본 동작 방지 (줄바꿈 방지)
         
            sendMessage();
        }
    });
});
        // 담당자 조회
        $(document).ready(function() {
            $('select[name="jobNo"]').change(function() {
                var jobNo = $(this).val();
                
                if (jobNo !== '0') {
                	$('#mgrNoProjWrks').show();
                	$('#updatemgrNoProjDwrks').show();
                	$('#mgrNoProjdWrks').show();
                	
                	$('#wrklabel').show();
                	$('#wrklabel2').show();
                	
                    $.ajax({
                        url: '/project/projectmgrlist/' + jobNo,
                        type: 'GET',
                        data: { jobNo: jobNo },
                        success: function(response) {
                            // 기존 옵션 삭제
                            $('#mgrNoProjWrks').empty().append('<option value="0">선택하세요</option>');
                            $('#mgrNoProjdWrks').empty().append('<option value="0">선택하세요</option>');
                            $('#mgrNoProjWrksUpdate').empty().append('<option value="0">선택하세요</option>');
                            
                            
                            
                            // 새로운 옵션 추가
                            $.each(response, function(index, info) {
                                $('#mgrNoProjWrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                                $('#mgrNoProjdWrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                                $('#mgrNoProjWrksUpdate').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                                
                                
                            });
                        },
                        error: function() {
                            alert('담당자 정보를 가져오는 데 실패했습니다.');
                        }
                    });
                } else {
                    // 기본 옵션으로 되돌리기
                    $('#mgrNoProjWrks').empty().append('<option value="0">선택하세요</option>');
                }
            });
        });
        
     // 수정 시 담당자 조회
        function handleJobNoChange(jobNo) {
            
            if (jobNo !== '0') {
                $('#mgrNoProjWrks').show();
                $('#wrklabel').show();
                
                $.ajax({
                    url: '/project/projectmgrlist/' + jobNo,
                    type: 'GET',
                    data: { jobNo: jobNo },
                    success: function(response) {
                        // 기존 옵션 삭제
                        $('#mgrNoProjWrks').empty().append('<option value="0">선택하세요</option>');
                        $('#editProjManager').empty().append('<option value="0">선택하세요</option>');
                        $('#mgrNoProjWrksUpdate2').empty().append('<option value="0">선택하세요</option>');
                        $('#updatemgrNoProjDwrks').empty().append('<option value="0">선택하세요</option>');
                        $('#mgrNoProjdWrks').empty().append('<option value="0">선택하세요</option>');
                        // 새로운 옵션 추가
                        $.each(response, function(index, info) {
                            $('#mgrNoProjWrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#editProjManager').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#mgrNoProjWrksUpdate2').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#updatemgrNoProjDwrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#mgrNoProjdWrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                        });
                    },
                    error: function() {
                    }
                });
            } else {
                // 기본 옵션으로 되돌리기
                $('#mgrNoProjWrks').empty().append('<option value="0">선택하세요</option>');
                $('#mgrNoProjWrks').hide(); // 선택 박스 숨기기
                $('#wrklabel').hide(); // 레이블 숨기기
            }
        }
     	// 작업 진행현황 업데이트
		function updateStatus(currentStatus){
			
			const pdwNo = $('#pdwNode').val();
			
			let isStatus = "";
			if(currentStatus == 'k1'){
				isStatus = 'k2';
				$.ajax({
                    url: '/project/projectupdatestatus/' + pdwNo,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                    pdwNo: pdwNo, isStatus : isStatus 
                    }),
                    success: function(response) {
                    	let buttonElement = $(`button[onclick="updateStatus('k1')"]`);
                    	 $('#chat .badge').remove();
                        // 버튼 추가
                        let statusBadge = '<span class="badge rounded-pill bg-info">진행중</span>';
                        $('#chat h4').after(statusBadge);
                    	buttonElement.replaceWith(`
                                <button type="button" class="btn btn-outline-success status-button" onclick="updateStatus('k2')" style="float: right;">
                                    컨펌요청
                                </button>
                            `);

                    }
				});
			}else if(currentStatus == 'k2'){
				isStatus = 'k3';
				$.ajax({
                    url: '/project/projectupdatestatus/' + pdwNo,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                    pdwNo: pdwNo, isStatus : isStatus 
                    }),
                    success: function(response) {
                    	let buttonElement = $(`button[onclick="updateStatus('${currentStatus}')"]`);
                    	$('#chat .badge').remove();
                    	buttonElement.remove();
                    	$('.status-button').remove();
                    	
                    	let statusBadge = '<span class="badge rounded-pill bg-info">컨펌중</span>';
                        $('#chat h4').after(statusBadge);
                    	

                    }
				});	
			}
			
		}
		
    </script>

    <!-- 재귀 함수 정의 -->
    <th:block th:fragment="renderNode(projno, projname, parentNo, table, level, jobNo)" th:data-current-table="${table}" id="'test'+${status.index}" th:data-index="${status.index}">
	    <li th:id="'node_' + ${projno}" style="display: none;">
		    <span th:onclick="'toggleChat(this, ' + ${level} + ', ' + ${pdwNo} + ')'">[[${projname}]]</span>
		    <button class="btn btn-info btn-lg no-border-button" th:onclick="'event.stopPropagation(); myFunction(this, ' + ${level} + ', ' + ${jobNo} + ')'" style="margin-left: 5px;">
        		<i class="mdi mdi-plus-circle-outline" style="color:black; margin-right: 10px; " ></i>
    		</button>
    		
		    <button class="btn btn-info btn-lg no-border-button"  th:onclick="'event.stopPropagation(); myInfo(this, ' + ${level} + ')'">
        		<i class="fas fa-edit" style="color:black;"></i>
    		</button>
    	<ul style="display: none;"> 
        <th:block th:each="child, status : ${projects}" th:if="${child.parentNo == projno}">
            <span th:data-current-table="${table}" th:data-index="${status.index}" id="'test'+${status.index}"></span>
            <th:block th:replace="~{::renderNode(projno=${child.no}, projname=${child.name}, parentNo=${projno}, table=${child.table}, level=${child.level}, jobNo=${child.jobNo}, pdwNo=${child.pdwNo})}"></th:block>
        </th:block>
	    </ul>
		</li>
    </th:block>
</div>
