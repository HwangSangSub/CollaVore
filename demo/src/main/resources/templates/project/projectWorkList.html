<div class="page-wrapper" xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">

	<link rel="stylesheet" href="/dist/css/style.tree.css" />
	<link rel="stylesheet" href="/dist/css/style.min.tree.css" />
	<style>
.no-border-button {
	border: none;
	background: transparent;
	padding: 0;
	cursor: pointer;
}

.insert-panel {
	border: 1px solid #ccc;
	padding: 10px;
	margin-left: 20px;
	overflow: hidden; /* 내용이 넘치지 않도록 설정 */
	transition: max-height 0.3s ease; /* 부드러운 전환 효과 */
}

/* 페이지 기본 스타일 */
.body-page-wrapper {
	padding: 20px;
	background-color: #f9f9f9;
	align-items: center;
}
/* Breadcrumb 스타일 */
.breadcrumb {
	background-color: #ffffff;
	padding: 10px 20px;
	border-radius: 10px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	height: 70px;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 20px;
	color: #333;
	position: relative;
}

.breadcrumb h4 {
	margin: 0;
	font-size: 24px;
	font-weight: bold;
	color: #333;
}

.breadcrumb-left {
	display: flex; /* flexbox로 요소 정렬 */
	flex-direction: column; /* 세로로 배치 */
	justify-content: center; /* 세로 중앙 정렬 */
}

.breadcrumb-left h4 {
	font-size: 22px;
	font-weight: bold;
	margin: 0; /* 기본 마진 제거 */
	margin-top: 2px;
}

.breadcrumb-left p {
	font-size: 14px;
	color: #666;
	margin-top: 2px;
	margin-bottom: 0;
}

.breadcrumb-right span {
	font-size: 14px;
	color: #999;
	white-space: nowrap;
	position: relative;
	top: -12px;
}

/* 검색 기능을 위한 컨테이너 */
.search-container {
	display: flex;
	justify-content: flex-end; /* 오른쪽 정렬 */
	margin-bottom: 15px; /* 테이블과의 간격 */
}

/* 검색 입력 박스 스타일 */
#searchBox {
	padding: 8px;
	font-size: 14px;
	border: 1px solid #ddd;
	border-radius: 5px;
	width: 200px;
	margin-right: 10px;
}

/* 테이블 스타일 */
.memberList_table {
	width: 100%;
	border-collapse: collapse;
	font-size: 14px;
	text-align: left;
	margin-bottom: 5px;
}

.memberList_table thead th {
	text-align: center;
	font-weight: bold;
	color: #555;
	padding: 12px;
	border-bottom: 2px solid #ddd;
	font-weight: bold;
}

.memberList_table tbody td {
	text-align: center;
	font-size: 12px;
	color: #666666;;
	padding: 5px 20px;
	border-bottom: 1px solid #ddd;
	color: #333;
	white-space: nowrap; /* 텍스트가 여러 줄로 나뉘지 않고 한 줄로 유지됩니다 */
	overflow: hidden; /* 넘친 텍스트를 숨깁니다 */
	text-overflow: ellipsis; /* 넘친 텍스트는 "..."으로 표시됩니다 */
}

.memberList_table tbody tr:hover {
	background-color: #f9f9f9; /* 마우스 오버 시 행 배경색 변경 */
}

.form-select {
	border: none;
}

.pagination-and-insert-wrapper {
	display: flex;
	justify-content: space-between; /* 페이지네이션과 등록 버튼을 좌우로 배치 */
	align-items: center; /* 세로 중앙 정렬 */
	width: 100%; /* 전체 너비 사용 */
	padding: 10px;
}

.pagination-outer {
	text-align: center; /* 페이지네이션을 중앙 정렬 */
	flex-grow: 1;
}

.pagination {
	font-family: 'Ubuntu', sans-serif;
	display: inline-flex;
	position: relative;
	margin-top: 0;
	margin-bottom: 0;
}

/* prev 또는 next 클래스를 가지지 않는 경우에만 배경 적용 */
.pagination li a.page-link:not(.prev):not(.next) {
	color: #333;
	background-color: #e7e7e7; /* 배경 적용 */
	font-size: 20px;
	font-weight: 500;
	line-height: 39px;
	height: 40px;
	width: 40px;
	padding: 0;
	margin: 0 5px;
	border: none;
	border-radius: 10px;
	position: relative;
	z-index: 1;
	transition: all 0.3s ease 0s;
}

/* prev 또는 next 클래스를 가진 경우에만 적용할 스타일 (필요 시 추가) */
.pagination li a.page-link.prev, .pagination li a.page-link.next {
	background-color: transparent; /* 배경 투명 */
	color: #333;
	font-size: 20px;
	font-weight: 500;
	line-height: 39px;
	height: 40px;
	width: 40px;
	padding: 0;
	margin: 0 5px;
	border: none;
	position: relative;
	z-index: 1;
	transition: all 0.3s ease 0s;
}

/* prev 또는 next를 가지지 않는 .page-link에만 적용 */
.pagination li a.page-link:not(.prev):not(.next):hover, .pagination li a.page-link:not(.prev):not(.next):focus,
	.pagination li.active a.page-link:not(.prev):not(.next):hover,
	.pagination li.active a.page-link:not(.prev):not(.next) {
	color: #fff;
	background: transparent;
}

.pagination li a.page-link:not(.prev):not(.next):before, .pagination li a.page-link:not(.prev):not(.next):after
	{
	content: '';
	background: linear-gradient(to right, #706fd3 50%, transparent 50%);
	height: 100%;
	width: 100%;
	border-radius: 50%;
	opacity: 0;
	position: absolute;
	left: 0;
	top: 0;
	z-index: -1;
	transition: all 0.4s ease 0s;
}

.pagination li a.page-link:not(.prev):not(.next):after {
	background: linear-gradient(to right, #474787 50%, transparent 50%);
	transform: rotateY(180deg);
	top: auto;
	bottom: 0;
}

.pagination li a.page-link:not(.prev):not(.next):hover:before,
	.pagination li a.page-link:not(.prev):not(.next):focus:before,
	.pagination li.active a.page-link:not(.prev):not(.next):before,
	.pagination li a.page-link:not(.prev):not(.next):hover:after,
	.pagination li a.page-link:not(.prev):not(.next):focus:after,
	.pagination li.active a.page-link:not(.prev):not(.next):after {
	height: 85%;
	opacity: 1;
}

@media only screen and (max-width: 480px) {
	.pagination {
		font-size: 0;
		border: none;
		display: inline-block;
	}
	.pagination li {
		display: inline-block;
		vertical-align: top;
		margin: 0 0 10px;
	}
}

button {
	padding: 5px 10px;
	background-color: #9b8df6;
	color: white;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	font-size: 14px;
	transition: background-color 0.3s ease;
}

.insert-btn-container {
	text-align: right; /* 등록 버튼을 오른쪽 정렬 */
	padding-right: 10px;
}

/* 마우스 호버 시 효과 */
button:hover {
	background-color: #5a4bcf;
}

/* 추가적인 버튼 스타일링 */
button:active {
	background-color: #4839a9;
}

.none {
	display: none;
}

.tree {
	list-style-type: none;
	padding-left: 20px;
}

.subtree {
	display: none; /* 기본적으로 서브트리는 숨김 */
}

.node {
	cursor: pointer;
	padding: 5px;
	background-color: #f0f0f0;
	border: 1px solid #ccc;
	margin: 2px;
}

.node:hover {
	background-color: #e0e0e0;
}
/* 검색된 노드에 대한 스타일 */
.jstree-search {
	color: #212121; /* 어두운 검정색 텍스트 */
	font-weight: 600; /* 텍스트를 더 굵게 */
	letter-spacing: 0.5px; /* 문자 간격을 조금 넓혀서 가독성 향상 */
	text-transform: uppercase; /* 텍스트를 대문자로 변환 */
	font-size: 14px; /* 글자 크기 설정 */
	transition: color 0.3s ease; /* 글자 색 변화 시 부드럽게 전환 */
}

/* 호버 효과: 하이라이트된 텍스트에 마우스를 올리면 색상 변경 */
.jstree-search:hover {
	color: #000000; /* 마우스를 올리면 텍스트 색상 좀 더 강조 */
	transform: scale(1.1); /* 마우스를 올렸을 때 글자가 살짝 커지는 효과 */
}

.jstree-default .jstree-search {
	font-style: italic;
	color: #212121;
	font-weight: bold;
}
/* 검색 입력 박스 디자인 */
#search-container {
	margin-bottom: 20px;
	display: flex;
	align-items: center;
}

#search-input {
	width: 100%; /* 너비를 100%로 설정하여 부모 영역에 맞게 확장 */
	max-width: 300px; /* 최대 너비 설정 */
	padding: 7px 15px; /* 패딩을 설정하여 입력 영역을 넓힘 */
	border: 2px solid #ddd; /* 연한 회색 테두리 */
	border-radius: 30px; /* 둥근 모서리 */
	font-size: 14px; /* 글자 크기 */
	color: #333; /* 어두운 글자 색 */
	outline: none; /* 포커스 시 기본 outline 제거 */
	transition: border-color 0.3s ease, box-shadow 0.3s ease;
	/* 부드러운 애니메이션 */
}

#search-input:focus {
	border-color: #0066cc; /* 포커스 시 테두리 색상 */
	box-shadow: 0 0 8px rgba(0, 102, 204, 0.3); /* 포커스 시 그림자 효과 */
}

/* 검색 아이콘 스타일 */
#search-icon {
	top: 50%;
	font-size: 22px; /* 아이콘 크기 키우기 */
	margin-right: 10px; /* 오른쪽 마진 추가 */
	pointer-events: none; /* 클릭 이벤트를 받지 않도록 */
	color: #666; /* 아이콘 색상 */
}
/* 검색 컨테이너가 화면의 반만 차지하도록 설정 */
#search-container {
	width: 50%; /* 화면 너비의 50%만 차지 */
	max-width: 600px; /* 최대 너비를 600px로 제한 */
	display: flex;
	align-items: center;
	position: relative; /* 아이콘을 절대 위치로 배치할 때 필요 */
}
</style>
	<div class="body-page-wrapper">
		<div class="purple-background-container">
			<div class="breadcrumb">
				<div class="breadcrumb-left">
					<h4>프로젝트 업무 관리</h4>
					<p>프로젝트 업무 관리 페이지 입니다.</p>
				</div>
				<div class="breadcrumb-right">
					<span>프로젝트 관리 > 프로젝트 업무 관리</span>
				</div>
			</div>
			<div class="card_memberList">
				<div id="search-container">
					<i class="fas fa-search" id="search-icon"></i> <input type="text"
						id="search-input" placeholder="업무 제목을 입력해주세요." />

				</div>
				<div class="container-fluid" th:data-current-table="${table}"
					id="fluidDiv">
					<div class="row">
						<div id="jstree" class="col-md-6" th:fragment="reload">
							<ul>
								<th:block th:each="project : ${projects}"
									th:if="${project.parentNo == null}">
									<th:block
										th:replace="~{::renderNode(projno=${project.no}, projname=${project.name}, parentNo=${project.parentNo}, table=${project.table}, level=${project.level}, jobNo=${project.jobNo}, pdwNo=${project.pdwNo})}"></th:block>
								</th:block>
							</ul>
						</div>

						<div class="col-md-6">
							<div class="insert-panel" id="insertPanelProjwrks"
								style="display: none;">
								<h4>Insert Project</h4>
								<form id="insertFormProjwrks">
									<div>
										<label for="nameProjWrks" class="form-label">업무 이름</label> <input
											type="text" id="nameProjWrks" name="name"
											class="form-control" required>
									</div>
									<div>
										<label class="form-label">업무 내용</label> <input type="text"
											id="contentProjWrks" name="content" class="form-control"
											required>
									</div>
									<div>
										<label class="form-label">업무 타입</label> <select
											class="form-select" name="jobNo" id="jobNoProjWrks" required>
											<option value="0">선택하세요</option>
											<option th:each="info : ${jobs}" th:value="${info.jobNo}">[[${info.name}]]</option>
										</select>
									</div>
									<div>
										<label class="form-label" id="wrklabel" style="display: none;">업무
											담당자</label> <select class="form-select" name="mgrNo"
											id="mgrNoProjWrks" style="display: none;" required>
											<option value="0">선택하세요</option>
											<option th:each="info : ${projmgriist}"
												th:value="${info.empNo}">[[${info.name}]]</option>
										</select>
									</div>
									<input type="hidden" id="projNo" name="projNo">
									<div>
										<button type="submit" class="btn btn-primary">생성</button>
									</div>
								</form>
							</div>
							<div class="insert-panel" id="insertPanelProjdwrks"
								style="display: none;">
								<h4>Insert Project</h4>
								<form id="insertFormProjdwrks">
									<div>
										<label for="nameProjDwrks" class="form-label">업무 이름</label> <input
											type="text" id="nameProjDwrks" name="name"
											class="form-control" required>
									</div>
									<div>
										<label class="form-label">업무 내용</label> <input type="text"
											id="contentProjDwrks" name="content" class="form-control"
											required>
									</div>
									<label for="importance" class="form-label">중요도</label> <select
										class="form-select" name="importance" id="importance" required>
										<option value="l1">낮음</option>
										<option value="l2">중간</option>
										<option value="l3">높음</option>
									</select> <label for="isStatus" class="form-label">진행상황</label> <select
										class="form-select" name="isStatus" id="insertisStatus"
										required>
										<option value="k1">진행전</option>
										<option value="k2">진행중</option>
										<option value="k3">완 료</option>
									</select>
									<div>
										<label class="form-label">업무 시작일</label> <input type="date"
											id="startDate" name="startDate" class="form-control" required>
									</div>
									<div>
										<label class="form-label">업무 종료일</label> <input type="date"
											id="compDate" name="compDate" class="form-control" required>
									</div>
									<div>
										<label class="form-label" id="wrklabel2">업무 담당자</label> <select
											class="form-select" name="mgrNo" id="mgrNoProjdWrks" required>
											<option value="0">선택하세요</option>
											<option th:each="info : ${projmgriist}"
												th:value="${info.empNo}">[[${info.name}]]</option>
										</select>

									</div>
									<div>
										<input type="hidden" id="selPwNo" name="selPwNo">
									</div>
									<div>
										<input type="hidden" id="selParentPdwNo" name="selParentPdwNo">
									</div>
									<div>
										<button type="submit" class="btn btn-primary">생성</button>
									</div>
								</form>
							</div>



							<div class="insert-panel" id="wrkInfo" style="display: none;">
								<h4>업무 수정</h4>
								<form id="updateFormWrks">
									<div>
										<label for="nameProjWrks" class="form-label">업무 이름</label> <input
											type="text" id="nameProjWrksUpdate" name="name"
											class="form-control" required>
									</div>
									<div>
										<label class="form-label">업무 내용</label> <input type="text"
											id="contentProjWrksUpdate" name="content"
											class="form-control" required>
									</div>
									<div>
										<label class="form-label">업무 타입</label> <select
											class="form-select" name="jobNo" id="jobNoWrks" required>
											<option value="0">선택하세요</option>
											<option th:each="info : ${jobs}" th:value="${info.jobNo}">[[${info.name}]]</option>
										</select>
									</div>
									<div>
										<label class="form-label">업무 담당자</label> <select
											class="form-select" name="mgrNo" id="mgrNoProjWrksUpdate2"
											required>
											<option value="0">선택하세요</option>
											<option th:each="info : ${projmgriist}"
												th:value="${info.empNo}">[[${info.name}]]</option>
										</select>
									</div>
									<div></div>
									<input type="hidden" id="pwNo" name="pwNo" class="form-control">
									<div>
										<button type="submit" class="btn btn-primary">수정</button>
									</div>
								</form>
							</div>
							<div class="insert-panel" id="dwrkInfo" style="display: none;">
								<h4>Insert Project</h4>
								<form id="updateFormProjdwrks">
									<div>
										<label for="nameProjDwrks" class="form-label">상세업무 이름</label>
										<input type="text" id="projdwrkname" name="name"
											class="form-control" required>
									</div>
									<div>
										<label class="form-label">상세업무 내용</label> <input type="text"
											id="projdwrkcontent" name="content" class="form-control"
											required>
									</div>
									<label for="importance" class="form-label">중요도</label> <select
										class="form-select" name="importance" id="updateimportance"
										required>
										<option value="" disabled selected>선택하세요</option>
										<option value="l1">낮음</option>
										<option value="l2">중간</option>
										<option value="l3">높음</option>
									</select> <label for="isStatus" class="form-label">진행상황</label> <select
										class="form-select" name="isStatus" id="updateisStatus"
										required>
										<option value="" disabled selected>선택하세요</option>
										<option value="k1">진행전</option>
										<option value="k2">진행중</option>
										<option value="k3">컨펌중</option>
										<option value="k4">완 료</option>
									</select>
									<div>
										<label class="form-label">업무 시작일</label> <input type="date"
											id="updatestartDate" name="startDate" class="form-control"
											required>
									</div>
									<div>
										<label class="form-label">업무 종료일</label> <input type="date"
											id="updatecompDate" name="compDate" class="form-control"
											required>
									</div>
									<div>
										<label class="form-label" id="wrklabel2">업무 담당자</label> <select
											class="form-select" name="mgrNo" id="updatemgrNoProjDwrks"
											required>
											<option value="0">선택하세요</option>
											<option th:each="info : ${projmgriist}"
												th:value="${info.empNo}">[[${info.name}]]</option>
										</select>
									</div>
									<input type="hidden" id="pdwNumber" name="pdwNo"
										class="form-control">
									<div>
										<button type="submit" class="btn btn-primary">수정</button>
										<button type="button"
											class="btn btn-danger text-white delete-btn"
											data-type="projectdwrk">삭제</button>
									</div>
								</form>
							</div>
							<div class="insert-panel" id="editProjectModal"
								style="display: none;">
								<h4>프로젝트 수정</h4>
								<form id="editProjectForm">
									<div>
										<label for="nameProjDwrks" class="form-label">프로젝트 이름</label>
										<input type="text" class="form-control" name="name"
											id="editProjName" required oninput="validateInput(this)"
											placeholder="영어만 입력해주세요.">
									</div>
									<div>
										<label class="form-label">프로젝트 내용</label> <input type="text"
											id="editProjContent" name="content" class="form-control"
											required>

									</div>
									<div>

										<label class="form-label">업무 타입</label> <select
											class="form-select" name="jobNo" id="editjobNoProjWrks"
											required>
											<option value="0">선택하세요</option>
											<option th:each="info : ${jobs}" th:value="${info.jobNo}">[[${info.name}]]</option>
										</select>
									</div>
									<div>
										<label class="form-label" id="wrklabel">업무 담당자</label> <select
											class="form-select" name="pMgrNo" id="editProjManager"
											required>
											<option value="0">선택하세요</option>
											<option th:each="info : ${projmgriist}"
												th:value="${info.empNo}">[[${info.name}]]</option>
										</select>

									</div>
									<div class="mb-3">
										<label for="editProjStatus" class="form-label">진행상태</label> <select
											class="form-select" name="isStatus" id="editProjStatus"
											required>
											<option value="">선택하세요</option>
											<option value="j1">진행전</option>
											<option value="j2">진행중</option>
											<option value="j3">완료</option>
										</select>
									</div>
									<div>
										<label class="form-label">시작일</label> <input type="date"
											id="editProjStartDate" name="startDate" class="form-control"
											required>
									</div>
									<div>
										<label class="form-label">마감일</label> <input type="date"
											id="editProjEndDate" name="endDate" class="form-control"
											required>
									</div>
									<input type="hidden" id="projNo" name="projNo"
										class="form-control">
									<div>
										<button type="submit" class="btn btn-primary">수정</button>
									</div>
								</form>
							</div>
							<div class="card" id="chat" style="display: none;">
								<div class="card-body">
									<h4 class="card-title">Chat Option</h4>
									<div class="chat-box scrollable" style="height: 475px">
										<span class="badge rounded-pill bg-secondary"
											th:if="${isStatus == 'k1'}">진행전</span> <span
											class="badge rounded-pill bg-info"
											th:if="${isStatus == 'k2'}">진행중</span> <span
											class="badge rounded-pill bg-success"
											th:if="${isStatus == 'k3'}">완 료</span>

										<!--chat Row -->
										<ul class="chat-list" id="chat-list">
											<!--chat Row -->

											<li class="chat-item">
												<div class="chat-img">
													<img src="/assets/images/users/default.png" alt="user" />
												</div>
												<div class="chat-content">
													<h6 class="font-medium"></h6>
													<div class="box bg-light-info"></div>
												</div>
												<div class="chat-time"></div>
											</li>

											<li class="odd chat-item">
												<div class="chat-content">
													<div class="box bg-light-inverse"></div>
													<br />
												</div>
												<div class="chat-time"></div>
											</li>

										</ul>
									</div>
								</div>
								<div class="card-body border-top">
									<div class="row">
										<div class="col-9">
											<div class="input-field mt-0 mb-0">
												<textarea id="textarea1" placeholder="이곳에 입력하세요"
													class="form-control border-0"></textarea>
											</div>
										</div>
										<div class="col-3">
											<input type="hidden" name="pdwNo" id="pdwNode"> <a
												class="btn-circle btn-lg btn-cyan float-end text-white"
												id="send-chat-btn"> <i class="mdi mdi-send fs-3"> </i>
											</a>
										</div>
									</div>
								</div>
							</div>
							<!-- 프로젝트 Info -->
							<div class="insert-panel" id="projinfodel" style="display: none;">
								<h4>프로젝트 Info</h4>
								<form id="projinofodelform">
									<div class="mb-3">
										<label for="nameProjWrks" class="form-label">프로젝트 명</label> <input
											type="text" id="projectname" name="name" class="form-control"
											readonly>
									</div>
									<div class="mb-3">
										<label class="form-label">개 요</label> <input type="text"
											id="projectcontent" name="content" class="form-control"
											readonly>
									</div>
									<div class="mb-3">
										<label class="form-label">프로젝트 시작</label> <input type="text"
											id="projectstartdate" name="startDate" class="form-control"
											readonly>
									</div>
									<div class="mb-3">
										<label class="form-label">프로젝트 종료</label> <input type="text"
											id="projectenddate" name="endDate" class="form-control"
											readonly>
									</div>
									<div class="mb-3">
										<span class="badge rounded-pill bg-secondary"
											th:if="${isStatus == 'j1'}">진행전</span> <span
											class="badge rounded-pill bg-info"
											th:if="${isStatus == 'j2'}">진행중</span> <span
											class="badge rounded-pill bg-success"
											th:if="${isStatus == 'j3'}">완 료</span>
									</div>

									<div>
										<label class="form-label">업무 타입</label> <select
											class="form-select" name="jobNo" id="jobnoinfo" disabled>
											<option value="0">선택하세요</option>
											<option th:each="info : ${jobs}" th:value="${info.jobNo}">[[${info.name}]]</option>
										</select>
									</div>
									<div class="mb-3">
										<label class="form-label">업무 담당자</label> <select
											class="form-select" name="pMgrNo" id="projectmgrno" disabled>
											<option value="0">선택하세요</option>
											<option th:each="info : ${projmgriist}"
												th:value="${info.empNo}">[[${info.name}]]</option>
										</select>
									</div>

									<div></div>
									<div>
										<input type="hidden" name="projNo" id="projNumber">
										<button type="button"
											class="btn btn-danger text-white delete-btn"
											data-type="project">삭제</button>
									</div>
								</form>
							</div>

							<div class="insert-panel" id="wrkInfodel" style="display: none;">
								<h4>업무 Info</h4>
								<form id="wrkinfodelform">
									<div>
										<label for="nameProjWrks" class="form-label">업무 이름</label> <input
											type="text" id="wrkname" name="name" class="form-control"
											readonly>
									</div>
									<div>
										<label class="form-label">업무 내용</label> <input type="text"
											id="wrkcontent" name="content" class="form-control" readonly>
									</div>
									<div>
										<label class="form-label">업무 타입</label> <select
											class="form-select" name="jobNo" id="jobwrks" disabled>
											<option value="0">선택하세요</option>
											<option th:each="info : ${jobs}" th:value="${info.jobNo}">[[${info.name}]]</option>
										</select>
									</div>
									<div>
										<label class="form-label">업무 담당자</label> <select
											class="form-select" name="mgrNo" id="wrkmgrinfo" disabled>
											<option value="0">선택하세요</option>
											<option th:each="info : ${projmgriist}"
												th:value="${info.empNo}">[[${info.name}]]</option>
										</select>
									</div>
									<div></div>
									<div>
										<input type="hidden" name="pwNo" id="wrkNumber">
										<button type="button"
											class="btn btn-danger text-white delete-btn" data-type="work">삭제</button>
									</div>
								</form>
							</div>

						</div>

					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Include jQuery library -->
	<!-- Include jsTree -->
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

	<script>
    // 세션 아이디 변수
    const sessionUserEmpNo = '[[${session.userEmpNo}]]';
    
    // sysdate날짜 
    function getCurrentDate() {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
        const day = String(date.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
    }
		    
		    $(document).ready(function() {
		        // jsTree 초기화 및 검색 플러그인 활성화
		        
		        $('#jstree').jstree({
		            'plugins': ['search']  // search 플러그인 활성화
		        });
		        // 'no-border-button' 클릭 시 자식 노드 토글
		        $('#jstree').on('click', '.no-border-button', function(e) {
		            e.stopPropagation();
		            $(this).siblings('ul').toggle(); 
		        });

		        $(document).ready(function() {
		            // jsTree 초기화
		            $('#jstree').jstree();

		            // refresh.jstree 이벤트 리스너
		            $('#jstree').on('refresh.jstree', function() {
		                //console.log('트리가 새로 고쳐졌습니다!');
		                // 트리가 새로 고쳐진 후 필요한 작업
		            });

		            // 폼 제출 시 새 노드 추가
		            $('#insertFormProjwrks').on('submit', function(e) {
		                e.preventDefault(); // 기본 제출 이벤트 방지

		                const formData = $(this).serialize(); // 폼 데이터 직렬화

		                // 디버깅: 폼 데이터 확인
		                //console.log('폼 데이터:', formData);

		                $.ajax({
		                    type: 'POST',
		                    url: '/project/projectwrkinsert',
		                    data: formData,
		                    dataType: 'json',
		                    success: function(response) {
		                        //console.log('응답 데이터:', response);

		                        if (response && response.data) {
		                            alert('프로젝트가 성공적으로 추가되었습니다.');
		                        	let pwNo = response.data.pwNo;
		                            //tree.open_all();
		                            // 특정 노드만 새로 고침하기 위한 함수 호출
		                            resetJstree('#node_W' + pwNo);

		                            // 폼 초기화
		                            $('#insertFormProjwrks')[0].reset();
		                        } else {
		                            alert('서버에서 올바른 데이터를 받지 못했습니다.');
		                        }
		                    },
		                    error: function(xhr, status, error) {
		                        //console.log('오류:', xhr.responseText);
		                        alert('오류가 발생했습니다: ' + error);
		                    }
		                });
		            });
		        });





            $('#insertFormProjdwrks').on('submit', function(e) {
                e.preventDefault(); // 기본 제출 이벤트 방지
                const formData = $(this).serialize(); // 폼 데이터 직렬화
                
                $.ajax({
                    type: 'POST',
                    url: '/project/projectdwrkinsert', // 폼의 action URL
                    data: formData,
                    success: function(response) {
                        alert('상세 업무가 성공적으로 추가되었습니다: ');
                        //console.log(response);
                        // jsTree에 새 상세 업무 노드 추가
                        const parentNodeId = 'node_' + response.data.parentNo; // 부모 노드 ID
                        const newDetailNode = {
                            id: 'node_' + response.data.pdNo, // 새 상세 업무 노드의 ID
                            text: response.data.name, // 새 상세 업무 노드의 텍스트
                            children: [] // 자식 노드 초기화
                        };

                     // jsTree에 노드 추가
                        const tree = $('#jstree').jstree();
                        tree.create_node(parentNodeId, newDetailNode, 'last', function(newNode) {
                            //console.log('새 상세 업무 노드가 추가되었습니다:', newNode);
                        });

                        // 새로 추가된 노드만 새로 고침
                        tree.refresh(true);
                        //tree.open_all();
                        // 특정 노드만 새로 고침하기 위한 함수 호출
                        resetJstree();
                        //location.reload(true); // 페이지 새로고침
                        // 폼 초기화
                        $('#insertFormProjdwrks')[0].reset();
                    },
                    error: function(xhr, status, error) {
                        alert('오류가 발생했습니다: ' + error);
                    }
                });
            });
        });

        function myFunction(buttonElement, level, jobNo) {
            const projectName = $(buttonElement).parent().find('span').text().trim();

            const projNo = $(buttonElement).parent().attr('id').split('_')[1];

            let currentNode = $(buttonElement).parent();
            let pwNo = null;

            // 최상위 부모 찾기
            while (currentNode.length) {
                const currentPwNo = currentNode.attr('id').split('_')[1];
                
                // pwNo 값이 존재하면 저장
                if (currentPwNo) {
                    pwNo = currentPwNo; // 최상위 부모의 pwNo로 업데이트
                }

                // 부모 노드로 이동
                currentNode = currentNode.parent().closest('li'); // 부모 <li>를 찾기
            }
           
            
            
            if (level <= 1) {
                $('#insertPanelProjwrks h4').text(projectName + ' 업무 등록');
                $('#insertPanelProjwrks').show();
                $('#insertPanelProjdwrks').hide();
                $('#dwrkInfo').hide();
                $('#wrkInfo').hide();
                $('#editProjectModal').hide();
                $('#chat').hide();
                $('#wrkInfodel').hide();
                $('#projinfodel').hide();
                
            } else {
                $('#insertPanelProjdwrks h4').text(projectName + ' 상세업무 등록');
                handleJobNoChange(jobNo);
                $('#test').show();
                $('#insertPanelProjwrks').hide();
                $('#insertPanelProjdwrks').show();
                $('#dwrkInfo').hide();
                $('#wrkInfo').hide();
                $('#editProjectModal').hide();
                $('#chat').hide();
                $('#wrkInfodel').hide();
                $('#projinfodel').hide();
            }

            $('#projNo').val(projNo.replace(/^[PW]/, ''));
            /* $('#parentPdwNo').val(projNo.replace(/^[PW]/, ''));
            $('#pwNo').val(pwNo.replace(/^[PW]/, '')); */
            //$('#projNo').val(projNo);
            $('#selParentPdwNo').val(projNo);
            $('#selPwNo').val(pwNo);

        }
        
        
    
        function myInfo(buttonElement, level) {
            const projectName = $(buttonElement).text(); 
            const projNo = $(buttonElement).parent().attr('id').split('_')[1]; 
            const pwNo = parseInt(projNo.replace(/^[PW]/, ''), 10); 
            
            
            if (level <= 1) {
            	$.ajax({
                    url: `/project/projectlistinfo/${pwNo}`, 
                    type: 'GET',
                    success: function(response) {
                    	// 옵션값 함수 호출
                    	//console.log(response);
                    	handleJobNoChange(response.jobNo);
                       
                      	
                    	$('#editProjectModal').show();
                        $('#wrkInfo').hide();
                        $('#dwrkInfo').hide();
                        $('#insertPanelProjdwrks').hide();
                        $('#insertPanelProjwrks').hide();
                        $('#chat').hide();
                        $('#wrkInfodel').hide();
                        $('#projinfodel').hide();
                        
                        $('#editProjName').val(response.name);
                        $('#editProjContent').val(response.content);
                            $('#editProjManager').val(response.pmgrNo); // 선택된 값을 설정
                        $('#editProjGit').val(response.projectGitUrl);
                        $('#editProjStatus').val(response.status);
                        $('#projNo').val(response.projNo);
                        $('#editjobNoProjWrks').val(response.jobNo);
                        
                        const formatDate = (dateString) => {
                            const date = new Date(dateString);
                            return date.toISOString().split('T')[0]; 
                        }; 
                        $('#editProjStartDate').val(formatDate(response.startDate));
                        $('#editProjEndDate').val(formatDate(response.endDate));   
                    }
            	});
            }else if(level <= 2){
                $('#wrkInfo h4').text(projectName + ' 업무 수정');
                $('#wrkInfo').show();
                $('#editProjectModal').hide();
                $('#dwrkInfo').hide();
                $('#insertPanelProjdwrks').hide();
                $('#insertPanelProjwrks').hide();
                $('#chat').hide();
                $('#wrkInfodel').hide();
                $('#projinfodel').hide();
                
                $.ajax({
                    url: `/project/projectwrklistinfo/${pwNo}`, 
                    type: 'GET',
                    dataType: 'json', 
                    success: function(response) {
                    	// 옵션값 함수 호출
                    	handleJobNoChange(response.jobNo);
                    	
                        $('#nameProjWrksUpdate').val(response.name);
                        $('#contentProjWrksUpdate').val(response.content);
                        $('#jobNoWrks').val(response.jobNo);
                            $('#mgrNoProjWrksUpdate2').val(response.mgrNo); // 선택된 값을 설정
                    },
                    error: function(xhr, status, error) {
                        alert('프로젝트 정보를 가져오는 데 실패했습니다: ' + error);
                    }
                });
            }else {
                $('#dwrkInfo h4').text(projectName + ' 상세업무 수정');
                $('#wrkInfo').hide();
                $('#dwrkInfo').show();  
                $('#insertPanelProjdwrks').hide();
                $('#insertPanelProjwrks').hide();
                $('#editProjectModal').hide();
                $('#chat').hide();
                $('#wrkInfodel').hide();
                $('#projinfodel').hide();
                
                $.ajax({
                    url: `/project/projectdwrkinfo/${pwNo}`, 
                    type: 'GET',
                    dataType: 'json', 
                    success: function(response) {
                    	
                    	handleJobNoChange(response.jobNo);
                        $('#projdwrkname').val(response.name);
                        $('#projdwrkcontent').val(response.content);
                        $('#updateimportance').val(response.importance); 
                        const formatDate = (dateString) => {
                            const date = new Date(dateString);
                            return date.toISOString().split('T')[0]; 
                        }; 
                        $('#updatestartDate').val(formatDate(response.startDate));
                        $('#updatecompDate').val(formatDate(response.compDate));
                        $('#updatecommitId').val(response.commitId);
                        $('#hiddenjobNoWrks').val(response.jobNo);
                            $('#updatemgrNoProjDwrks').val(response.mgrNo); // 선택된 값을 설정
                        $('#updateisStatus').val(response.isStatus);
                        $('#selPwNo').val(pwNo); 
                        $('#selParentPdwNo').val(projNo); 
                    },
                    error: function(xhr, status, error) {
                        alert('프로젝트 정보를 가져오는 데 실패했습니다: ' + error);
                    }
                });
            }
            
            // projNo를 hidden input에 설정
            $('#projNo').val(projNo.replace(/^[PW]/, '')); 
            $('#pwNo').val(pwNo); 
            $('#pdwNumber').val(pwNo); 
            
            $('#selPwNo').val(pwNo); 
            $('#selParentPdwNo').val(projNo); 
            
            
        }
    	// 프로젝트 수정 처리
        $('#editProjectForm').on('submit', function(e) {
        	//console.log($('#editProjManager').val());
        	e.preventDefault();
            $.ajax({
                url: `/project/projectupdate`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    projNo: $('#projNo').val(),
                    name: $('#editProjName').val(),
                    content: $('#editProjContent').val(),
                    pmgrNo: $('#editProjManager').val(),
                    projectGitUrl: $('#editProjGit').val(),
                    status: $('#editProjStatus').val(),
                    startDate: $('#editProjStartDate').val(),
                    endDate: $('#editProjEndDate').val()
                    

                }),
                success: function(response) {
                    alert('프로젝트가 성공적으로 수정되었습니다!');

                    $('#editProjectModal').hide(); // 수정 모달 닫기
                    //location.reload(true); // 페이지 새로고침
                    let pwNo = response.data.pwNo;
                    //tree.open_all();
                    // 특정 노드만 새로 고침하기 위한 함수 호출
                    resetJstree();
                },
                error: function(xhr, status, error) {
                    alert('프로젝트 수정에 실패했습니다: ' + error);
                }
            });
        });
    	
    	
     // 업무 수정 처리
        $('#updateFormWrks').on('submit', function(e) {
        	e.preventDefault();
            $.ajax({
                url: `/project/projectwrkupdate`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    pwNo: $('#pwNo').val(),
                    name: $('#nameProjWrksUpdate').val(),
                    content: $('#contentProjWrksUpdate').val(),
                    jobNo: $('#jobNoWrks').val(),
                    mgrNo: $('#mgrNoProjWrksUpdate2').val(),
                    

                }),
                success: function(response) {
                    alert('프로젝트가 성공적으로 수정되었습니다!');

                    $('#updateFormProjdwrks').hide();
                    //location.reload(true); // 페이지 새로고침
                    //tree.open_all();
                    // 특정 노드만 새로 고침하기 위한 함수 호출
                    resetJstree();
                },
                error: function(xhr, status, error) {
                    alert('프로젝트 수정에 실패했습니다: ' + error);
                }
            });
        });
     // 상세업무 수정 처리
        $('#updateFormProjdwrks').on('submit', function(e) {
        	e.preventDefault();
            
            $.ajax({
                url: `/project/projectdwrkupdate`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    pdwNo: $('#pdwNumber').val(),
                    name: $('#projdwrkname').val(),
                    content: $('#projdwrkcontent').val(),
                    isStatus: $('#updateisStatus').val(),
                    startDate: $('#updatestartDate').val(),
                    compDate: $('#updatecompDate').val(),
                    commitId: $('#updatecommitId').val(),
                    importance: $('#updateimportance').val(),
                    mgrNo: $('#updatemgrNoProjDwrks').val(),
                    

                }),
                success: function(response) {
                    alert('상세업무가 성공적으로 수정되었습니다!');

                    $('#dwrkInfo').hide(); // 수정 모달 닫기
                    //location.reload(true); // 페이지 새로고침
                    //tree.open_all();
                    // 특정 노드만 새로 고침하기 위한 함수 호출
                    resetJstree();
                },
                error: function(xhr, status, error) {
                    alert('프로젝트 수정에 실패했습니다: ' + error);
                }
            });
        });   
        function toggleChat(buttonElement, level) {
            const projectName = $(buttonElement).text();
            const projNo = $(buttonElement).parent().attr('id').split('_')[1];
            const pdwNo = parseInt(projNo.replace(/^[PW]/, ''), 10);
			const pwNo = pdwNo;
            const chat = document.getElementById('chat');
            
            if(level <= 1){
            	$('#projinfodel').show();
            	 $('#chat').hide();
                 $('#editProjectModal').hide();
                 $('#wrkInfo').hide();
                 $('#dwrkInfo').hide();
                 $('#insertPanelProjdwrks').hide();
                 $('#insertPanelProjwrks').hide();
                 $('#wrkInfodel').hide();
                 
                 
                 $.ajax({
                	    url: `/project/projectlistinfo/${pwNo}`, 
                	    type: 'GET',
                	    success: function(response) {
                	        // 옵션값 함수 호출
                	        handleJobNoChange(response.jobNo); // 여기서 비동기 작업이 시작됨
                	        //console.log(response);
                	        
                	        $('#projinfodel').show();
                	        $('#editProjectModal').hide();
                	        $('#wrkInfo').hide();
                	        $('#dwrkInfo').hide();
                	        $('#insertPanelProjdwrks').hide();
                	        $('#insertPanelProjwrks').hide();
                	        $('#chat').hide();
                	        $('#wrkInfodel').hide();
                	        
                	        // 값 설정
                	        $('#projinfodel h4').text(response.name);
                	        $('#projectname').val(response.name);
                	        $('#projectcontent').val(response.content);
                	        $('#projectgiturl').val(response.projectGitUrl);
                	        $('#jobnoinfo').val(response.jobNo);
                	        $('#projNumber').val(response.projNo);
                	        
                	        const formatDate = (dateString) => {
                	            const date = new Date(dateString);
                	            return date.toISOString().split('T')[0]; 
                	        }; 
                	        $('#projectstartdate').val(formatDate(response.startDate));
                	        $('#projectenddate').val(formatDate(response.endDate));
                	        
                
                	        $('#projectmgrno').val(response.pmgrNo);
                	    }
                	});
            }else if(level <= 2){
                $('#wrkInfodel').show();
                $('#projinfodel').hide();
                $('#chat').hide();
                $('#editProjectModal').hide();
                $('#wrkInfo').hide();
                $('#dwrkInfo').hide();
                $('#insertPanelProjdwrks').hide();
                $('#insertPanelProjwrks').hide();
                
                

                $.ajax({
                    url: `/project/projectwrklistinfo/${pwNo}`, 
                    type: 'GET',
                    dataType: 'json', 
                    success: function(response) {
                        // 응답 확인
                        //console.log('Response:', response);
                        handleJobNoChange(response.jobNo, response.mgrNo);
                        
                        // DOM 요소에 값 설정
                        $('#wrkInfodel h4').text(projectName);
                        $('#wrkname').val(response.name);
                        $('#wrkcontent').val(response.content);
                        $('#jobwrks').val(response.jobNo);
                        $('#wrkNumber').val(response.pwNo);
                            $('#wrkmgrinfo').val(response.mgrNo); // 선택된 값을 설정
                    },
                    error: function(xhr, status, error) {
                        alert('프로젝트 정보를 가져오는 데 실패했습니다: ' + error);
                        //console.error(`Error: ${status} - ${error}`);
                    }
                });

            }else {
                $('#chat').show();
                $('#editProjectModal').hide();
                $('#wrkInfo').hide();
                $('#dwrkInfo').hide();
                $('#insertPanelProjdwrks').hide();
                $('#insertPanelProjwrks').hide();
                $('#projinfodel').hide();
                $('#wrkInfodel').hide();
                
                $('#chat h4').text(projectName + ' 상세업무 코멘트');
                $('#pdwNode').val(pdwNo);
                $.ajax({
                    url: '/project/projecdwrkcomtstinfo/' + pdwNo,
                    method: 'GET',
                    success: function(data) {
                    	//console.log(data);
                        const chatList = $('#chat .chat-list');
                        chatList.empty();
                        let statusClass;
                        let statusText;
                     // importance는 mgrs 배열에서 가져옴
                        const projectManager = data.mgrs && data.mgrs[0];  // mgrs 배열에서 첫 번째 프로젝트 매니저 정보 가져오기
                        const importance = projectManager ? projectManager.importance : undefined;  // importance 값 확인
                        const startDate = projectManager ? projectManager.startDate : undefined;  // importance 값 확인
                        const compDate = projectManager ? projectManager.compDate : undefined;  // importance 값 확인
						
                     // 남은 일수 계산 함수
                        function calculateRemainingDays(endDate) {
                            const currentDate = new Date(); // 현재 날짜
                            const targetDate = new Date(endDate); // 완료일
                            const timeDifference = targetDate - currentDate; // 밀리초 단위 차이
                            const daysRemaining = Math.ceil(timeDifference / (1000 * 3600 * 24)); // 밀리초를 일수로 변환
                            return daysRemaining;
                        }
                        
                     // 남은 일수 계산 (D-xxx)
                        let remainingDays = '';
                        if (compDate) {
                        	 remainingDays = calculateRemainingDays(compDate); // 남은 일수만 추출
                        }
                     // 남은 일수에 따른 배지 색상 변경
                        let remainingDaysClass = '';
                        let remainingDaysText = `D-${remainingDays}`;
                        
                        if (remainingDays < 0) {
                            remainingDaysClass = 'bg-dark'; // 기간 종료는 다크 색상으로 표시
                            remainingDaysText = '기간 종료';
                        } else if (remainingDays <= 3) {
                            remainingDaysClass = 'bg-danger'; // 3일 미만
                        } else if (remainingDays <= 7) {
                            remainingDaysClass = 'bg-warning'; // 3일 이상 7일 미만
                        } else if (remainingDays >= 8) {
                            remainingDaysClass = 'bg-success'; // 8일 이상
                        }
                        //console.log(remainingDaysClass);
                        switch (importance) {
                            case 'l1':
                                statusClass = 'bg-secondary';
                                statusText = '낮 음';
                                break;
                            case 'l2':
                                statusClass = 'bg-info';
                                statusText = '중 간';
                                break;
                            case 'l3':
                                statusClass = 'bg-success';
                                statusText = '높 음';
                                break;
                        }
                        // 기존 배지 제거
                        $('#chat .badge').remove();
                        // 기존 버튼 제거
                        $('#chat .status-button').remove();
                        
                        // data가 객체 형태일 경우
                        if (data && data.comments && Array.isArray(data.comments)) {
                            // 상태를 먼저 확인하여 배지 생성
                            let statusBadge = '';
                            let actionButton = '';
                            
                            
                                const firstInfo = data.comments[0];
                                const projectManager = data.mgrs[0]; // 단일 객체가 리스트로 변환되었으므로 첫 번째 요소 사용
                                const managerEmpNo = projectManager.mgrNo; // 프로젝트 매니저의 empNo
                                
                                
                                if (projectManager.isStatus === 'k1' ) {
                                    statusBadge = '<span class="badge rounded-pill bg-secondary">진행전</span>';
                                    if(sessionUserEmpNo ==  managerEmpNo){
                                    actionButton = `
                                        <button type="button" class="btn btn-outline-info status-button" onclick="updateStatus('k1', '${managerEmpNo}')" style="float: right;">
                                            작업시작
                                        </button>`;
                                    }
                                } else if (projectManager.isStatus === 'k2') {
                                    statusBadge = '<span class="badge rounded-pill bg-info">진행중</span>';
                                    if(sessionUserEmpNo ==  managerEmpNo){
                                    actionButton = `
                                        <button type="button" class="btn btn-outline-success status-button" onclick="updateStatus('k2', '${managerEmpNo}')" style="float: right;">
                                            컨펌요청
                                        </button>`;
                                    }
                                } else if (projectManager.isStatus === 'k3') {
                                    statusBadge = '<span class="badge rounded-pill bg-info">컨펌중</span>';
                                    //console.log(projectManager.directboss);
                                    if(sessionUserEmpNo ==  projectManager.directboss){
                                    	actionButton = `
                                            <button type="button" class="btn btn-outline-success status-button" onclick="updateStatus('k4', '${managerEmpNo}')" style="float: right;">
                                                컨펌완료
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" id="delbtn" onclick="updateStatus('k5', '${managerEmpNo}')" style="float: right;">
                                                반려
                                            </button>`;
                                    }
                                } else if (projectManager.isStatus === 'k4') {
                                    statusBadge = '<span class="badge rounded-pill bg-success">완료</span>';
                                } 
                            
                            // status값에 따라 뱃지 및 버튼 노출
                           $('#chat h4').after(`
                                   <span class="badge rounded-pill ${statusClass}">${statusText}</span> 
                                   ${statusBadge}
                                   <span class="badge rounded-pill ${remainingDaysClass}">${remainingDaysText}</span> 
                               `);  // 상태 배지 추가
                            if(actionButton){
                            $('#chat h4').append(actionButton);
                            }
                            
                            data.comments.forEach(info => {
                                const isCurrentUser = parseInt(sessionUserEmpNo, 10) === parseInt(info.writerNo, 10);
                                
                                function formatDate(dateString) {
                                    const date = new Date(dateString);
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    return `${year}-${month}-${day}`;
                                }
                                
                                const chatItem = isCurrentUser
                                    ? `
                                        <li class="odd chat-item" data-id="${info.pdwcNo}">
                                            <div class="chat-content">
                                                <button class="btn btn-link btn-sm text-decoration-none delete-chat-btn">
                                                    <i class="me-2 mdi mdi-delete"></i>
                                                </button>
                                                <div class="box bg-light-inverse">${info.content}</div>
                                                <br />
                                            </div>
                                            <div class="chat-time">${formatDate(info.regDate)}</div>
                                            
                                            <input type="hidden" name="pdwcNo" value="${info.pdwcNo}">
                                        </li>`
                                    : `
                                        <li class="chat-item">
                                            <div class="chat-img">
                                                <img src="/assets/images/users/default.png" alt="user" />
                                            </div>
                                            <div class="chat-content">
                                                <h6 class="font-medium">${info.name}</h6>
                                                <div class="box bg-light-info">${info.content}</div>
                                            </div>
                                            <div class="chat-time">${formatDate(info.regDate)}</div>
                                        </li>`;

                                chatList.append(chatItem); // 생성한 HTML 요소를 chat-list에 추가
                            });

                        }
                    },
                    error: function(error) {
                        console.error("오류발생!:", error);
                    }
                });
            }
        }

     	
        // 상세업무 코멘트 등록
       $(document).ready(function() {
    // 채팅 메시지 전송 함수
    function sendMessage() {
        const message = $('#textarea1').val().trim(); // textarea의 내용을 가져옴
        //const pdwNo = $('#chat').data('pdwNo');
        const pdwNo = $('#pdwNode').val();
		//console.log(pdwNo);
        const writerNo = sessionUserEmpNo;
		
        if (message) {
            $.ajax({
                type: 'POST',
                url: '/project/projectdwrkcomtinsert', // 메시지를 처리할 서버 URL
                data: JSON.stringify({ content: message, pdwNo: pdwNo, writerNo: writerNo }),
                contentType: 'application/json',
                success: function(response) {
                    // 응답 처리 (예: 서버에서 반환된 채팅 내용을 추가)
                    const chatItem = `
                        <li class="odd chat-item">
                            <div class="chat-content">
                            <button class="btn btn-link btn-sm text-decoration-none delete-chat-btn">
                            <i class="me-2 mdi mdi-delete"></i>
                       		 </button>
                                <div class="box bg-light-inverse">${response.content}</div>
                                <br/>
                            </div>
                            <div class="chat-time">${getCurrentDate()}</div>
                            <input type="hidden" name="pdwcNo" id="pdwcNumber" value="${response.data.pdwcNo}">
                        </li>`;
                    
                    $('#chat-list').append(chatItem); // chat-list에 새 메시지 추가
                    $('#textarea1').val(''); // textarea 초기화
                },
                error: function(xhr, status, error) {
                    alert('코멘트 전송에 실패했습니다: ' + error);
                }
            });
        } else {
            alert('코멘트를 입력하세요!');
        }
    }

    // 버튼 클릭 이벤트
    $('#send-chat-btn').on('click', function() {
    	 
        sendMessage();
    });

    // 엔터 키 입력 이벤트
    $('#textarea1').on('keypress', function(event) {
        if (event.which === 13) { // 엔터 키
            event.preventDefault(); // 기본 동작 방지 (줄바꿈 방지)
         
            sendMessage();
        }
    });
});
        // 담당자 조회
        $(document).ready(function() {
            $('select[name="jobNo"]').change(function() {
                var jobNo = $(this).val();
                
                if (jobNo !== '0') {
                	$('#mgrNoProjWrks').show();
                	$('#updatemgrNoProjDwrks').show();
                	$('#mgrNoProjdWrks').show();
                	
                	$('#wrklabel').show();
                	$('#wrklabel2').show();
                	
                    $.ajax({
                        url: '/project/projectmgrlist/' + jobNo,
                        type: 'GET',
                        data: { jobNo: jobNo },
                        success: function(response) {
                            // 기존 옵션 삭제
                            $('#mgrNoProjWrks').empty().append('<option value="0">선택하세요</option>');
                            $('#mgrNoProjdWrks').empty().append('<option value="0">선택하세요</option>');
                            $('#mgrNoProjWrksUpdate').empty().append('<option value="0">선택하세요</option>');
                            $('#mgrNoProjWrksUpdate2').empty().append('<option value="0">선택하세요</option>');
                            $('#projectmgrno').empty().append('<option value="0">선택하세요</option>');
                            $('#editProjManager').empty().append('<option value="0">선택하세요</option>');
                            
                            
                            
                            // 새로운 옵션 추가
                            $.each(response, function(index, info) {
                                $('#mgrNoProjWrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                                $('#mgrNoProjdWrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                                $('#mgrNoProjWrksUpdate').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                                $('#mgrNoProjWrksUpdate2').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                                $('#projectmgrno').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                                $('#editProjManager').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                                
                                
                            });
                        },
                        error: function() {
                            alert('담당자 정보를 가져오는 데 실패했습니다.');
                        }
                    });
                } else {
                    // 기본 옵션으로 되돌리기
                    $('#mgrNoProjWrks').empty().append('<option value="0">선택하세요</option>');
                }
            });
        });
        
     // 수정 시 담당자 조회
        function handleJobNoChange(jobNo, mgrNo) {
            
            if (jobNo !== '0') {
                $('#mgrNoProjWrks').show();
                $('#wrklabel').show();
                
                $.ajax({
                    url: '/project/projectmgrlist/' + jobNo,
                    type: 'GET',
                    // 호출 받아도 먼저 실행 후 다른처리가 가능한 코드 
                    async: false,
                    data: { jobNo: jobNo },
                    success: function(response) {
                        // 기존 옵션 삭제
                        $('#mgrNoProjWrks').empty().append('<option value="0">선택하세요</option>');
                        $('#editProjManager').empty().append('<option value="0">선택하세요</option>');
                        $('#mgrNoProjWrksUpdate2').empty().append('<option value="0">선택하세요</option>');
                        $('#updatemgrNoProjDwrks').empty().append('<option value="0">선택하세요</option>');
                        $('#mgrNoProjdWrks').empty().append('<option value="0">선택하세요</option>');
                        $('#wrkmgrinfo').empty().append('<option value="0">선택하세요</option>');
                        $('#projectmgrno').empty().append('<option value="0">선택하세요</option>');
                        // 새로운 옵션 추가
                        $.each(response, function(index, info) {
                            $('#mgrNoProjWrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#editProjManager').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#mgrNoProjWrksUpdate2').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#updatemgrNoProjDwrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#mgrNoProjdWrks').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#wrkmgrinfo').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                            $('#projectmgrno').append('<option value="' + info.empNo + '">' + info.name + '</option>');
                        });

                    },
                    error: function() {
                    }
                });
            } else {
                // 기본 옵션으로 되돌리기
                $('#mgrNoProjWrks').empty().append('<option value="0">선택하세요</option>');
                $('#mgrNoProjWrks').hide(); // 선택 박스 숨기기
                $('#wrklabel').hide(); // 레이블 숨기기
            }
        }
     	// 작업 진행현황 업데이트
		function updateStatus(currentStatus, managerEmpNo){
			
			const pdwNo = $('#pdwNode').val();
			// 반려 시 초기값으로 돌림
			if(currentStatus == 'k5'){
				currentStatus = 'k1'
			}
			let isStatus = "";
			if(currentStatus == 'k1'){
				isStatus = 'k2';
				$.ajax({
                    url: '/project/projectupdatestatus/' + pdwNo,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                    pdwNo: pdwNo, isStatus : isStatus 
                    }),
                    success: function(response) {
                    	//console.log(response);
                    	let buttonElement = $(`button[onclick="updateStatus('k1')"]`);
                    	 $('#chat .badge').remove();
                    	 $('.status-button').remove();
                    	 $('#delbtn').remove();
                    	 
                        // 버튼 추가
                        let statusBadge = '<span class="badge rounded-pill bg-info">진행중</span>';
                        $('#chat h4').after(statusBadge);
                     // 새로운 버튼 추가
                     	
                        let newButton = `
                            <button type="button" class="btn btn-outline-success status-button" onclick="updateStatus('k2', '${managerEmpNo}')" style="float: right;">
                                컨펌요청
                            </button>
                        `;
                     	
						if(sessionUserEmpNo ==  managerEmpNo){
                        	$('#chat h4').append(newButton);
						}
                    }
				});
			}else if(currentStatus == 'k2'){
				isStatus = 'k3';
				$.ajax({
                    url: '/project/projectupdatestatus/' + pdwNo,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                    pdwNo: pdwNo, isStatus : isStatus 
                    }),
                    success: function(response) {
                    	let buttonElement = $(`button[onclick="updateStatus('${currentStatus}')"]`);
                    	$('#chat .badge').remove();
                    	buttonElement.remove();
                    	$('.status-button').remove();
                    	$('#delbtn').remove();
                    	
                    	let statusBadge = '<span class="badge rounded-pill bg-info">컨펌중</span>';
                        $('#chat h4').after(statusBadge);
                    }
				});	
			}else if(currentStatus == 'k4'){
				isStatus = 'k4';
				$.ajax({
                    url: '/project/projectupdatestatus/' + pdwNo,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                    pdwNo: pdwNo, isStatus : isStatus 
                    }),
                    success: function(response) {
                    	let buttonElement = $(`button[onclick="updateStatus('${currentStatus}')"]`);
                    	$('#chat .badge').remove();
                    	buttonElement.remove();
                    	$('.status-button').remove();
                    	$('#delbtn').remove();
                    	
                    	let statusBadge = '<span class="badge rounded-pill bg-success">완료</span>';
                        $('#chat h4').after(statusBadge);
                    }
				});					
			}
			
		}
		$(document).ready(function() {
		    // 삭제 버튼 클릭 이벤트
		    $('.delete-btn').on('click', function(event) {
		        event.preventDefault(); 

		        const type = $(this).data('type'); 
		        
		        const projNo = $('#projNumber').val();
		        const pwNo = $('#wrkNumber').val();
		        const pdwNo = $('#pdwNumber').val();
		        
		        //console.log	(pwNo);
		        //console.log	(pdwNo);
		        let url;
		        if (type === 'project') {
		            url = `/project/projectdelete/${projNo}`; // 프로젝트 삭제 URL
		        } else if (type === 'work') {
		        	
		            url = `/project/projectwrkdel/${pwNo}`; // 업무 삭제 URL
		        }else if( type === 'projectdwrk'){
		        	
		        	url = `/project/projectdwrkdelete/${pdwNo}`; // 상세업무 삭제 URL
		        }

		        if (confirm('정말로 삭제하시겠습니까?')) {
		            // AJAX 호출
		            $.ajax({
		                url: url, 
		                type: 'DELETE', 
		                success: function(response) {
		                    alert('삭제되었습니다.');
		                    //location.reload(true); // 페이지 새로고침
                            //tree.open_all();
                            // 특정 노드만 새로 고침하기 위한 함수 호출
                            resetJstree();
		                },
		                error: function(xhr, status, error) {
		                    alert('삭제 중 오류가 발생했습니다: ' + error);
		                }
		            });
		        }
		    });
		});
		
		// 삭제 버튼 클릭 이벤트 리스너 추가
		$(document).on('click', '.delete-chat-btn', function() {
		    const chatItem = $(this).closest('.chat-item');
		    //const pdwcNo = $(pdwcNumber).val();
		    const pdwcNo = chatItem.find('input[name="pdwcNo"]').val();
			//console.log(pdwcNo);
		    if (confirm('이 메시지를 삭제하시겠습니까?')) {
		        $.ajax({
		            url: `/project/projectcomtsdel/${pdwcNo}`, // 삭제 요청을 보낼 엔드포인트
		            method: 'DELETE',
		            data: { pdwcNo: pdwcNo },
		            success: function(response) {
		                    chatItem.remove(); // DOM에서 채팅 아이템 삭제
		            },
		            error: function() {
		                alert('메시지 삭제 중 오류가 발생했습니다.');
		            }
		        });
		    }
		});		
		function validateInput(input) {
		    const regex = /^[a-zA-Z0-9_ ]*$/; // 영어, 숫자, 언더바, 공백 허용하는 정규 표현식
		    
		    if (!regex.test(input.value)) {
		        alert("영어, 숫자, 공백, 언더바만 입력할 수 있습니다.");
		        input.value = input.value.replace(/[^a-zA-Z0-9_ ]/g, ''); // 유효하지 않은 문자 제거
		    }
		}
		
		document.addEventListener("DOMContentLoaded", function() {
		    // 우클릭 시 하위 트리 펼침/숨김 처리
		    window.toggleSubTree = function(event, element) {
		        // 기본 우클릭 메뉴를 막고 하위 트리 처리
		        event.preventDefault();  // 우클릭 기본 메뉴를 막음

		        // 우클릭한 li 항목의 바로 아래에 있는 ul 태그 찾기
		        const nodeId = $(element).closest("li").attr("id");

		        // 현재 노드를 기준으로 모든 하위 노드를 펼치거나 닫기
		        toggleAllSubNodes(nodeId);
		    };

		    // 모든 하위 노드를 펼치거나 닫는 함수
		    function toggleAllSubNodes(nodeId) {
		        // 현재 노드가 열린 상태인지 확인
		        const isNodeOpen = $('#jstree').jstree("is_open", nodeId);

		        // 현재 노드가 열려 있으면 모든 하위 노드를 닫고, 그렇지 않으면 열기
		        if (isNodeOpen) {
		            closeAllSubNodes(nodeId);
		        } else {
		            openAllSubNodes(nodeId);
		        }
		    }

		    // 모든 하위 노드를 재귀적으로 열기
		    function openAllSubNodes(nodeId) {
		        // 현재 노드를 열기
		        $('#jstree').jstree("open_node", nodeId);

		        // 해당 노드의 자식 노드를 찾아서 모두 재귀적으로 열기
		        const childNodes = $('#' + nodeId).find('li');
		        childNodes.each(function() {
		            const childNodeId = $(this).attr('id');
		            if (childNodeId) {
		                // 자식 노드를 열기
		                $('#jstree').jstree("open_node", childNodeId);
		                // 자식 노드의 하위 노드까지 열기
		                openAllSubNodes(childNodeId);
		            }
		        });
		    }

		    // 모든 하위 노드를 재귀적으로 닫기
		    function closeAllSubNodes(nodeId) {
		        // 현재 노드를 닫기
		        $('#jstree').jstree("close_node", nodeId);

		        // 해당 노드의 자식 노드를 찾아서 모두 재귀적으로 닫기
		        const childNodes = $('#' + nodeId).find('li');
		        childNodes.each(function() {
		            const childNodeId = $(this).attr('id');
		            if (childNodeId) {
		                // 자식 노드를 닫기
		                $('#jstree').jstree("close_node", childNodeId);
		                // 자식 노드의 하위 노드까지 닫기
		                closeAllSubNodes(childNodeId);
		            }
		        });
		    }
		});
        $('#search-input').on('input', function() {
            const query = $(this).val().trim(); // 입력값 가져오기
            if (query) {
                const tree = $('#jstree').jstree(true); // jsTree 인스턴스 가져오기
                tree.search(query); // 검색어로 검색 실행
            } else {
                const tree = $('#jstree').jstree(true);
                tree.clear_search(); // 입력 필드가 비었을 때 검색 초기화
            }
        });
        
        function resetJstree(){
        	fetch(`/project/projectworklist?fragment=reload`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
	        .then(response => response.text())
	        .then(html => {
	            $("#jstree").replaceWith(html);
	            
		        $('#jstree').jstree({
		            'plugins': ['search']  // search 플러그인 활성화
		        });
		        
		        // jsTree 초기화 후 트리의 모든 노드를 열기
		        $('#jstree').on('ready.jstree', function () {
		            // jstree 인스턴스 가져오기
		            const tree = $('#jstree').jstree(true);
		            
		            // setTimeout을 사용하여 트리가 완전히 초기화된 후 open_all 호출
		            setTimeout(function() {
		                // 모든 노드를 펼침
		                tree.open_all();

		            }, 0); // 0ms로 설정하여 즉시 호출 (트리 초기화 후)
		        });
	        });
        }
        
        
    </script>

	<!-- 재귀 함수 정의 -->
	<th:block
		th:fragment="renderNode(projno, projname, parentNo, table, level, jobNo)"
		th:data-current-table="${table}" id="'test'+${status.index}"
		th:data-index="${status.index}">

		<li th:id="'node_' + ${projno}" style="display: none;"
			oncontextmenu="toggleSubTree(event, this); return false;"><span
			th:onclick="'toggleChat(this, ' + ${level} + ', ' + ${pdwNo} + ')'">[[${projname}]]</span>
			<button class="btn btn-info btn-lg no-border-button"
				th:onclick="'event.stopPropagation(); myFunction(this, ' + ${level} + ', ' + ${jobNo} + ')'"
				style="margin-left: 5px;">
				<i class="mdi mdi-plus-circle-outline"
					style="color: black; margin-right: 10px;"></i>
			</button>

			<button class="btn btn-info btn-lg no-border-button"
				th:onclick="'event.stopPropagation(); myInfo(this, ' + ${level} + ')'">
				<i class="fas fa-edit" style="color: black;"></i>
			</button>
			<ul style="display: none;">
				<th:block th:each="child, status : ${projects}"
					th:if="${child.parentNo == projno}">
					<span th:data-current-table="${table}"
						th:data-index="${status.index}" id="'test'+${status.index}"></span>
					<th:block
						th:replace="~{::renderNode(projno=${child.no}, projname=${child.name}, parentNo=${projno}, table=${child.table}, level=${child.level}, jobNo=${child.jobNo}, pdwNo=${child.pdwNo})}"></th:block>
				</th:block>
			</ul></li>
	</th:block>
</div>
