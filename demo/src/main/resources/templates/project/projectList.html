<div class="page-wrapper" xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="Content">
<style>
  textarea {
    width: 100%;
    height: 6.25em;
    border: none;
    resize: none;
  }
</style>	
	<div class="page-breadcrumb">
		<div class="row">
			<div class="col-12 d-flex no-block align-items-center">
				<h4 class="page-title">프로젝트현황</h4>
				<div class="ms-auto text-end">
					<nav aria-label="breadcrumb">
						<ol class="breadcrumb">
							<li class="breadcrumb-item"><a href="#">Home</a></li>
							<li class="breadcrumb-item active" aria-current="page">
								Library</li>
						</ol>
					</nav>
				</div>
			</div>
		</div>
	</div>
	<div class="container-fluid">
		<div class="row">
			<!-- Column -->
			<div class="card">
				<div class="card-body">
					<h5 class="card-title mb-0">
						<button type="button" class="btn btn-info btn-lg"
							data-bs-toggle="modal" data-bs-target="#projectModal"
							style="float: right;">프로젝트생성</button>
					</h5>
				</div>
				<table class="table">
					<thead>
						<tr>
							<th scope="col">프로젝트번호</th>
							<th scope="col">프로젝트명</th>
							<th scope="col">진행상태</th>
							<th scope="col">시작일</th>
							<th scope="col">마감일</th>
							<th scope="col">프로젝트 담당자</th>
							<th scope="col"></th>
						</tr>
					</thead>
					<tbody>
						<th:block th:each="info : ${projects}">
							<tr>
								<th scope="row">[[${info.projNo}]]</th>
								<td>[[${info.name}]]</td>
								<td><span th:if="${info.status == 'j1'}">진행전</span> <span
									th:if="${info.status == 'j2'}">진행중</span> <span
									th:if="${info.status == 'j3'}">완료</span></td>
								<td>[[${#dates.format(info.startDate, "yyyy년MM월dd일")}]]</td>
								<td>[[${#dates.format(info.endDate, "yyyy년MM월dd일")}]]</td>
								<td>[[${info.pMgrNo}]]</td>
								<td>
								<button type="button" class="btn btn-warning">수정</button>
								 <button type="button" class="btn btn-danger text-white delete-btn" data-proj-no="[[${info.projNo}]]">삭제</button>
								</td>
							</tr>
						</th:block>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<!-- 모달 폼 -->
	<div class="modal fade" id="projectModal" tabindex="-1"
		aria-labelledby="projectModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="projectModalLabel">프로젝트 생성</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="projectForm">
						<div class="mb-3">
							<label for="projName" class="form-label">프로젝트 이름</label> 
							<input type="text" class="form-control" name="name" id="projName" required>
						</div>
						<div class="mb-3">
							<label for="projContent" class="form-label">프로젝트 개요</label> 
							<textarea class="form-control" name="content" id="projContent" rows="5" required></textarea>
						</div>
						<div class="mb-3">
							<label for="projManager" class="form-label">담당자</label> 
							<input type="text" class="form-control" name="pMgrNo" id="projManager" required>
						</div>
						<div class="mb-3">
							<label for="projManager" class="form-label">프로젝트Git주소</label> 
							<input type="text" class="form-control" name="projectGitUrl" id="projGit" required>
						</div>
						<div class="mb-3">
							<label for="projStatus" class="form-label">템플릿</label> 
							<select class="form-select" name="isTemplate" id="projTemp">
								<option value="i1">선택하세요</option>
							</select>
						</div>
						<div class="mb-3">
							<label for="projStatus" class="form-label">진행상태</label> 
							<select class="form-select" name="status" id="projStatus" required>
								<option value="">선택하세요</option>
								<option value="j1">진행전</option>
								<option value="j2">진행중</option>
								<option value="j3">완료</option>
							</select>
						</div>
						<div class="mb-3">
							<label for="projStartDate" class="form-label">시작일</label> 
							<input type="date" class="form-control" name="startDate" id="projStartDate" required>
						</div>
						<div class="mb-3">
							<label for="projEndDate" class="form-label">마감일</label> 
							<input type="date" class="form-control" name="endDate" id="projEndDate" required>
						</div>
						<button type="submit" class="btn btn-primary">생성</button>
					</form>
				</div>
			</div>
		</div>
	</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#projectForm').on('submit', function(event) {
            event.preventDefault(); 

            $.ajax({
                url: '/project/projectinsert', 
                type: 'POST',
                data: $(this).serialize(), 
                success: function(response) {
                    const newProject = response.data; 
                    function formatDate(dateString) {
                        const date = new Date(dateString);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 1을 더함
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}년${month}월${day}일`;
                    }
                    $('table tbody').append(`
                        <tr>
                            <th scope="row">${newProject.projNo}</th>
                            <td>${newProject.name}</td>
                            <td><span>${newProject.status === 'j1' ? '진행전' : newProject.status === 'j2' ? '진행중' : '완료'}</span></td>
                            <td>${formatDate(newProject.startDate)}</td>
                            <td>${formatDate(newProject.endDate)}</td>
                            <td>${newProject.pMgrNo}</td>
                        </tr>
                    `);

                    alert('프로젝트가 성공적으로 생성되었습니다!');
                    $('#projectModal').modal('hide'); 
                },
                error: function(xhr, status, error) {
                    alert('프로젝트 생성에 실패했습니다: ' + error);
                }
            });
        });
    });
   /*  $(document).ready(function() {
        $(document).on('click', '.delete-btn', function() {
            const projNo = $(this).data('proj-no'); 

            if (confirm('정말로 이 프로젝트를 삭제하시겠습니까?')) {
                $.ajax({
                    url: `/project/projectdelete/${projNo}`, 
                    type: 'DELETE',
                    success: function(response) {
                        alert('프로젝트가 성공적으로 삭제되었습니다!');
                        $(`button[data-proj-no="${projNo}"]`).closest('tr').remove();
                    },
                    error: function(xhr, status, error) {
                        alert('프로젝트 삭제에 실패했습니다: ' + error);
                    }
                });
            }
        });
    }); */
</script>
